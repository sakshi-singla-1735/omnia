---
- name: Size validation for admin_debug_packages
  when: admin_debug_enabled | default(false) | bool
  block:
    - name: Measure baseline image size (without admin_debug)
      ansible.builtin.stat:
        path: "{{ output_dir }}/baseline_{{ arch }}.squashfs"
      register: baseline_image
      failed_when: not baseline_image.stat.exists

    - name: Measure image with admin_debug packages
      ansible.builtin.stat:
        path: "{{ output_dir }}/{{ arch }}_base_image.squashfs"
      register: debug_image
      failed_when: not debug_image.stat.exists

    - name: Calculate size increase
      ansible.builtin.set_fact:
        size_delta_bytes: "{{ (debug_image.stat.size | int) - (baseline_image.stat.size | int) }}"
        size_delta_mb: "{{ ((debug_image.stat.size | int) - (baseline_image.stat.size | int)) / 1024 / 1024 }}"
        baseline_size_mb: "{{ baseline_image.stat.size / 1024 / 1024 }}"
        debug_size_mb: "{{ debug_image.stat.size / 1024 / 1024 }}"

    - name: Display size metrics
      ansible.builtin.debug:
        msg:
          - "{{ admin_debug_size_header }}"
          - "{{ admin_debug_baseline_msg }}"
          - "{{ admin_debug_with_debug_msg }}"
          - "{{ admin_debug_size_increase_msg }}"

    - name: Save size metrics to file
      ansible.builtin.copy:
        content: "{{ admin_debug_size_metrics_header }}"
        dest: "{{ output_dir }}/admin_debug_size_metrics_{{ arch }}.txt"
      delegate_to: localhost
