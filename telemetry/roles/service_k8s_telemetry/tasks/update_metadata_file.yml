#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- name: Check if namespace exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ telemetry_namespace }}"
  register: ns_info

- name: Fail if namespace does not exist
  ansible.builtin.fail:
    msg: "{{ telemetry_namespace_not_found }}"
  when: ns_info.resources | length == 0

- name: Get StatefulSet details
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: StatefulSet
    name: "{{ idrac_telemetry_k8s_name }}"
    namespace: "{{ telemetry_namespace }}"
  register: sts_info

- name: Fail if StatefulSet does not exist
  ansible.builtin.fail:
    msg: "{{ telemetry_deployments_not_found }}"
  when: sts_info.resources | length == 0

- name: Extract ready and expected replicas
  ansible.builtin.set_fact:
    sts_ready: "{{ sts_info.resources[0].status.readyReplicas | default(0) }}"
    sts_expected: "{{ sts_info.resources[0].spec.replicas | default(0) }}"

- name: Fail if not all replicas are ready
  ansible.builtin.fail:
    msg: "{{ telemetry_ready_replicas_failure_msg }}"
  when: sts_ready != sts_expected

- name: Include service_cluster metadata if already exists
  ansible.builtin.include_vars: "{{ service_cluster_metadata_path }}"
  delegate_to: localhost
  connection: local
  no_log: true
  failed_when: false

- name: Set idrac-telemetry replica count
  ansible.builtin.set_fact:
    idrac_telemetry_replicas: >-
      {{
        service_cluster_metadata
        | dict2items
        | selectattr('value.parent_status', 'defined')
        | selectattr('value.parent_status', 'equalto', true)
        | selectattr('value.child_groups', 'defined')
        | selectattr('value.role', 'defined')
        | selectattr('value.role', 'search', 'service_kube_node')
        | list
        | length
      }}

- name: Scale idrac-telemetry StatefulSet using JSON patch
  kubernetes.core.k8s_json_patch:
    api_version: apps/v1
    kind: StatefulSet
    name: idrac-telemetry
    namespace: telemetry
    patch: |
      [
        {
          "op": "replace",
          "path": "/spec/replicas",
          "value": {{ (idrac_telemetry_replicas | int) + 1 }}
        }
      ]

- name: Generating iDRAC telemetry pods names
  ansible.builtin.set_fact:
    idrac_telemetry_pods: >-
      {{
        range(1, (idrac_telemetry_replicas | int) + 1)
        | map('regex_replace', '^', idrac_telemetry_k8s_name ~ '-')
        | list
      }}

- name: Assign iDRAC telemetry pod to MGMT_node
  ansible.builtin.set_fact:
    service_cluster_metadata: >-
      {{
        service_cluster_metadata | combine({
          'MGMT_node': service_cluster_metadata['MGMT_node']
          | combine({
              'idrac_podname': idrac_telemetry_k8s_name ~ '-0'
          })
        }, recursive=True)
      }}

- name: Wait for each iDRAC telemetry pod to be ready
  ansible.builtin.command: >
    kubectl wait --for=condition=ready pod/{{ item }}
    -n {{ telemetry_namespace }} --timeout={{ pod_wait_timeout }}
  loop: "{{ idrac_telemetry_pods }}"
  changed_when: false

- name: Get service cluster node details
  ansible.builtin.set_fact:
    kube_compute_nodes: >-
      {{ service_cluster_metadata | dict2items
         | selectattr("value.role", "defined")
         | selectattr("value.role", "search", "^service_kube_node")
         | sort(attribute="key") | list }}

- name: Identify unassigned service nodes and idrac-telemetry pods
  ansible.builtin.set_fact:
    unassigned_compute_nodes: >-
      {{
        (kube_compute_nodes
         | rejectattr('value.idrac_podname', 'defined')
         | list)
      }}
    assigned_pods: >-
      {{
        kube_compute_nodes
        | map(attribute='value.idrac_podname')
        | select('defined')
        | list
        | default([])
      }}

- name: Identify unassigned telemetry pods
  ansible.builtin.set_fact:
    unassigned_pods: >-
      {{ idrac_telemetry_pods | reject('in', assigned_pods) | list }}

- name: Build new pod assignments for unassigned nodes
  ansible.builtin.set_fact:
    new_metadata_items: "{{ new_metadata_items | default([]) + [
        {
          item.0.key: item.0.value | combine({ 'idrac_podname': item.1 })
        }
      ] }}"
  loop: "{{ unassigned_compute_nodes | zip(unassigned_pods) | list }}"

- name: Append new pod details in service_cluster metadata
  ansible.builtin.set_fact:
    service_cluster_metadata: "{{ service_cluster_metadata | combine(new_metadata_items | default([]) | combine, recursive=True) }}"


- name: Update service_cluster metadata file
  ansible.builtin.copy:
    content: "{{ {'kube_client_share_path': kube_client_share_path, 'kube_vip': kube_vip, 'service_cluster_metadata': service_cluster_metadata} | to_nice_yaml }}" # noqa: yaml[line-length]
    dest: "{{ service_cluster_metadata_path }}"
    force: true
    mode: "{{ metadata_perm }}"
  delegate_to: localhost
  connection: local
  no_log: true
