---
# Kubernetes Secret Encryption setup tasks

- name: Set default vars for encryption
  ansible.builtin.set_fact:
    encryption_config_path: /etc/kubernetes/encryption-config.yaml
    num_keys: 2

- name: Generate random 32-byte Base64 keys
  ansible.builtin.shell: "set -o pipefail; head -c 32 /dev/urandom | base64"
  register: encryption_keys
  with_sequence: count="{{ num_keys }}"
  changed_when: false

- name: Set encryption key list
  ansible.builtin.set_fact:
    keys_list: "{{ encryption_keys.results | map(attribute='stdout') | list }}"

- name: Build EncryptionConfiguration YAML
  ansible.builtin.copy:
    dest: "{{ encryption_config_path }}"
    content: |
      apiVersion: apiserver.config.k8s.io/v1
      kind: EncryptionConfiguration
      resources:
        - resources:
            - secrets
          providers:
            - aescbc:
                keys:
      {% for key in keys_list %}
                  - name: key{{ loop.index }}
                    secret: {{ key }}
      {% endfor %}
            - identity: {}
    owner: root
    group: root
    mode: '0600'

- name: Ensure kube-apiserver uses encryption config
  ansible.builtin.blockinfile:
    path: /etc/kubernetes/manifests/kube-apiserver.yaml
    block: "  - --encryption-provider-config=/etc/kubernetes/encryption-config.yaml"
    marker: ""
    insertafter: '  - --tls-private-key-file=/etc/kubernetes/ssl/apiserver.key'

- name: Restart kube-apiserver container (via kubelet restart)
  ansible.builtin.systemd:
    name: kubelet
    state: restarted
