#!/bin/bash
set -e

LOGFILE="/var/log/nvhpc_sdk_install.log"
exec > >(tee -a "$LOGFILE") 2>&1

echo "===== Starting NVIDIA HPC SDK installation ====="

NVHPC_PKG_NAME="{{ nvhpc_pkg_name | default('nvhpc_2025_2511_Linux_x86_64_cuda_13.0') }}"
NVHPC_EXPORT="{{ cloud_init_nfs_path }}/hpc_tools/nvidia_sdk"
NVHPC_MOUNT="/shared-nvhpc-sdk"
NVHPC_TARBALL="{{ NVHPC_MOUNT }}/{{ NVHPC_PKG_NAME }}.tar.gz"
NVHPC_INSTALL_DIR_NFS="{{ NVHPC_MOUNT }}/nvhpc"
NVHPC_LOCAL_MOUNT="/opt/nvidia/nvhpc"
NVHPC_EXTRACT_DIR="{{ NVHPC_MOUNT }}/{{ NVHPC_PKG_NAME }}"

# Skip if already mounted
if mountpoint -q "$NVHPC_LOCAL_MOUNT"; then
    echo "[INFO] $NVHPC_LOCAL_MOUNT already mounted. Skipping installation."
    exit 0
fi

# Skip if local directory exists
if [ -d "$NVHPC_LOCAL_MOUNT" ]; then
    echo "[INFO] $NVHPC_LOCAL_MOUNT exists. Assuming installed. Skipping."
    exit 0
fi

mkdir -p "$NVHPC_MOUNT"
mount -t nfs "$NVHPC_EXPORT" "$NVHPC_MOUNT"

# Check tarball
echo "[INFO] Checking NVIDIA HPC SDK tarball at $NVHPC_TARBALL..."
if [ ! -f "$NVHPC_TARBALL" ]; then
    echo "[ERROR] NVIDIA HPC SDK tarball not found. Skipping installation."
    exit 0
fi

# Extract if needed
EXTRACT_SIZE_GB=$(du -sBG "$NVHPC_EXTRACT_DIR" 2>/dev/null | cut -f1 | tr -d 'G')
if [ -d "$NVHPC_EXTRACT_DIR" ] && [ "$EXTRACT_SIZE_GB" -ge 13 ] && [ -f "$NVHPC_EXTRACT_DIR/install" ]; then
    echo "[INFO] NVHPC already extracted. Skipping."
else
    echo "[INFO] Extracting NVIDIA HPC SDK tarball..."
    tar -xzf "$NVHPC_TARBALL" -C "$NVHPC_MOUNT" \
        --checkpoint=2000 \
        --checkpoint-action=echo="[INFO] Extracting NVHPC... please wait"
fi

mkdir -p "$NVHPC_INSTALL_DIR_NFS"
INSTALL_BIN_DIR="$NVHPC_INSTALL_DIR_NFS/Linux_x86_64/25.11/compilers/bin"

if [ -x "$INSTALL_BIN_DIR/nvc" ]; then
    echo "[INFO] NVHPC already installed. Skipping installer."
else
    echo "[INFO] Running NVIDIA HPC SDK installer..."
    cd "$NVHPC_EXTRACT_DIR"
    NVHPC_SILENT=true NVHPC_INSTALL_DIR="$NVHPC_INSTALL_DIR_NFS" NVHPC_INSTALL_TYPE=auto ./install
fi

echo "[SUCCESS] NVIDIA HPC SDK installation completed."

# Mount NVHPC locally
mkdir -p "$NVHPC_LOCAL_MOUNT"
NVHPC_INSTALL_EXPORT="{{ cloud_init_nfs_path }}/hpc_tools/nvidia_sdk/nvhpc"
FSTAB_ENTRY="$NVHPC_INSTALL_EXPORT $NVHPC_LOCAL_MOUNT nfs defaults,_netdev 0 0"

if ! grep -qE "^[^#].*$NVHPC_INSTALL_EXPORT[[:space:]]+$NVHPC_LOCAL_MOUNT[[:space:]]+nfs" /etc/fstab; then
    echo "[INFO] Adding NVHPC mount to /etc/fstab"
    echo "$FSTAB_ENTRY" >> /etc/fstab
fi

echo "[INFO] Mounting $NVHPC_LOCAL_MOUNT..."
mount "$NVHPC_LOCAL_MOUNT"
echo "[INFO] NVHPC successfully mounted at $NVHPC_LOCAL_MOUNT"