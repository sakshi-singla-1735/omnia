#!/bin/bash
set -e

CLIENT_MOUNT="{{ client_mount_path }}"

NVHPC_LOCAL_MOUNT="/opt/nvidia/nvhpc"
NVARCH="$(uname -s)_$(uname -m)"
NVHPC_VERSION="25.11"

NVHPC_BASE="$NVHPC_LOCAL_MOUNT/$NVARCH/$NVHPC_VERSION"
PROFILE_FILE="/etc/profile.d/nvhpc.sh"
LOGFILE="/var/log/export_nvhpc_env.log"

# Log everything
exec > >(tee -a "$LOGFILE") 2>&1

# Check that NFS is mounted
if ! mountpoint -q "$CLIENT_MOUNT"; then
    echo "[ERROR] $CLIENT_MOUNT is not mounted."
    echo "        Please mount the NFS path before running export_nvhpc_env.sh"
    exit 1
fi

echo "===== NVHPC environment export started ====="

# Validate compilers directory exists
if [ ! -d "$NVHPC_BASE/compilers/bin" ]; then
    echo "[ERROR] NVHPC compilers not found at:"
    echo "        $NVHPC_BASE/compilers/bin"
    exit 1
fi

echo "[INFO] Writing persistent NVHPC profile at $PROFILE_FILE"

# Write environment file system-wide
cat > "$PROFILE_FILE" <<EOF
# NVIDIA HPC SDK environment

export NVCOMPILERS=$NVHPC_LOCAL_MOUNT
export NVARCH=$NVARCH
export NVHPC_VERSION=$NVHPC_VERSION

# Compilers
export PATH=\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/compilers/bin:\$PATH
export MANPATH=\${MANPATH:-}:\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/compilers/man

# MPI support
export PATH=\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/comm_libs/mpi/bin:\$PATH
export MANPATH=\${MANPATH:-}:\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/comm_libs/mpi/man

# Modules
export MODULEPATH=\$NVCOMPILERS/modulefiles:\${MODULEPATH:-}
EOF

chmod 644 "$PROFILE_FILE"

echo "[INFO] Verifying NVHPC compilers using login shell"

# Verify nvc
if ! bash -lc "command -v nvc && nvc --version >/dev/null"; then
    echo "[ERROR] nvc verification failed"
    exit 1
fi

# Verify nvfortran
if ! bash -lc "command -v nvfortran && nvfortran --version >/dev/null"; then
    echo "[ERROR] nvfortran verification failed"
    exit 1
fi

echo "[SUCCESS] NVHPC environment exported successfully"
echo "[INFO] Environment file configured in $PROFILE_FILE"
echo "===== NVHPC export completed ====="