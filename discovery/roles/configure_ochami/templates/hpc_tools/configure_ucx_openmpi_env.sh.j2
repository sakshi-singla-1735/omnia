#!/bin/bash
LOGFILE="/var/log/configure_ucx_openmpi_env.log"
exec > >(tee -a "$LOGFILE") 2>&1

echo "===== Configuring UCX / OpenMPI environment (Slurm node) ====="

CLIENT_MOUNT="{{ client_mount_path }}"
UCX_PREFIX="{{ client_mount_path }}/slurm/hpc_tools/benchmarks/ucx"
OPENMPI_PREFIX="{{ client_mount_path }}/slurm/hpc_tools/benchmarks/openmpi"

PROFILE_DIR="/etc/profile.d"

# Ensure client mount exists and is mounted
if ! mountpoint -q "$CLIENT_MOUNT"; then
    echo "[WARN] $CLIENT_MOUNT is not mounted. Skipping UCX/OpenMPI env setup."
    exit 0
fi

# ---------------- UCX ----------------
if [ -d "$UCX_PREFIX/bin" ]; then
    echo "[INFO] UCX detected at $UCX_PREFIX"

    cat > "$PROFILE_DIR/ucx.sh" <<EOF
# UCX environment
export UCX_HOME="$UCX_PREFIX"
export PATH="\$UCX_HOME/bin:\$PATH"
export LD_LIBRARY_PATH="\$UCX_HOME/lib:\$LD_LIBRARY_PATH"
EOF

    chmod 644 "$PROFILE_DIR/ucx.sh"
    echo "[SUCCESS] UCX environment enabled"
else
    echo "[INFO] UCX not found at $UCX_PREFIX — skipping"
    rm -f "$PROFILE_DIR/ucx.sh"
fi

# ---------------- OpenMPI ----------------
if [ -d "$OPENMPI_PREFIX/bin" ]; then
    echo "[INFO] OpenMPI detected at $OPENMPI_PREFIX"

    cat > "$PROFILE_DIR/openmpi.sh" <<EOF
# OpenMPI environment
export OPENMPI_HOME="$OPENMPI_PREFIX"
export PATH="\$OPENMPI_HOME/bin:\$PATH"
export LD_LIBRARY_PATH="\$OPENMPI_HOME/lib:\$LD_LIBRARY_PATH"
export MANPATH="\$OPENMPI_HOME/share/man:\$MANPATH"
EOF

    chmod 644 "$PROFILE_DIR/openmpi.sh"
    echo "[SUCCESS] OpenMPI environment enabled"
else
    echo "[INFO] OpenMPI not found at $OPENMPI_PREFIX — skipping"
    rm -f "$PROFILE_DIR/openmpi.sh"
fi

echo "===== UCX / OpenMPI environment configuration complete ====="