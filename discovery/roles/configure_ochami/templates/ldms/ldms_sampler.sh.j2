#!/bin/bash
# ============================================================
# LDMS Setup Script
# ============================================================

LOG_FILE="/var/log/ldms-cloudinit.log"
echo "===== Starting LDMS setup =====" | tee -a "$LOG_FILE"

echo "Copying LDMS sampler configuration files..." | tee -a "$LOG_FILE"

# Copy sampler.conf and ldmsauth.conf
for file in sampler.conf ldmsauth.conf; do
    src="{{ client_mount_path }}/ldms/samplers/$file"
    dest="/opt/ovis-ldms/etc/ldms/$file"
    if [ -f "$src" ]; then
        sudo cp -rf "$src" "$dest"
        echo "✓ Copied $file" | tee -a "$LOG_FILE"
    else
        echo "Warning: $file not found in NFS share" | tee -a "$LOG_FILE"
    fi
done

# --- Export LDMS environment variables ---
echo "Sourcing LDMS environment variables..." | tee -a "$LOG_FILE"
if [ -f /opt/ovis-ldms/etc/profile.d/set-ovis-variables.sh ]; then
    source /opt/ovis-ldms/etc/profile.d/set-ovis-variables.sh
else
    echo "Environment file /opt/ovis-ldms/etc/profile.d/set-ovis-variables.sh not found. Continuing..." | tee -a "$LOG_FILE"
fi

# --- Copy LDMS sampler environment file from NFS share ---
echo "Copying LDMS sampler environment file from NFS share..." | tee -a "$LOG_FILE"
if [ -f {{ client_mount_path }}/ldms/samplers/ldmsd.sampler.env ]; then
    sudo cp {{ client_mount_path }}/ldms/samplers/ldmsd.sampler.env /opt/ovis-ldms/etc/ldms/ldmsd.sampler.env
    echo "✓ Copied ldmsd.sampler.env" | tee -a "$LOG_FILE"
else
    echo "Warning: ldmsd.sampler.env not found in NFS share" | tee -a "$LOG_FILE"
fi

# --- Source environment file to get port ---
if [ -f /opt/ovis-ldms/etc/ldms/ldmsd.sampler.env ]; then
    source /opt/ovis-ldms/etc/ldms/ldmsd.sampler.env
    echo "✓ Sourced ldmsd.sampler.env (Port: $LDMSD_PORT)" | tee -a "$LOG_FILE"
else
    LDMSD_PORT=10001
    echo "Warning: Using default port $LDMSD_PORT" | tee -a "$LOG_FILE"
fi

# --- Configure and enable LDMS service ---
echo "Configuring and enabling LDMS service..." | tee -a "$LOG_FILE"
if [ -f /opt/ovis-ldms/etc/systemd/system/ldmsd.sampler.service ]; then
    sudo cp /opt/ovis-ldms/etc/systemd/system/ldmsd.sampler.service /etc/systemd/system/
    sudo systemctl daemon-reload
    sudo systemctl enable ldmsd.sampler.service
    sudo systemctl start ldmsd.sampler.service
    sudo systemctl status ldmsd.sampler.service --no-pager | tee -a "$LOG_FILE"
else
    echo "Service file not found: /opt/ovis-ldms/etc/systemd/system/ldmsd.sampler.service" | tee -a "$LOG_FILE"
fi

# Configure firewall safely

echo "Configuring firewall for LDMS port $LDMSD_PORT..." | tee -a "$LOG_FILE"
sudo firewall-cmd --permanent --add-port=$LDMSD_PORT/tcp
sudo firewall-cmd --reload

# --- Verify LDMS connection and metrics ---
echo "Verifying LDMS connection and metrics..." | tee -a "$LOG_FILE"
/opt/ovis-ldms/sbin/ldms_ls -a ovis -A conf=/opt/ovis-ldms/etc/ldms/ldmsauth.conf -p $LDMSD_PORT -h localhost | tee -a "$LOG_FILE"
/opt/ovis-ldms/sbin/ldms_ls -l -a ovis -A conf=/opt/ovis-ldms/etc/ldms/ldmsauth.conf -p $LDMSD_PORT -h localhost > /tmp/metrics

echo "===== LDMS setup completed =====" | tee -a "$LOG_FILE"
