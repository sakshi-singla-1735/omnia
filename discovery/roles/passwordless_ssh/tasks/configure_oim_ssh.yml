# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
# tasks/configure_oim_ssh.yml

- name: Gather cluster hostnames and IP wildcard patterns from localhost facts
  ansible.builtin.set_fact:
    k8s_cluster_hostnames: "{{ hostvars['localhost']['k8s_cluster_hostnames'] | default([]) }}"
    slurm_cluster_hostnames: "{{ hostvars['localhost']['slurm_cluster_hostnames'] | default([]) }}"
    omnia_cluster_ip_patterns_raw: "{{ hostvars['localhost']['omnia_cluster_ip_patterns'] | default([]) }}"
    omnia_hosts_map: "{{ hostvars['localhost']['omnia_hosts_map'] | default({}) }}"

- name: Normalize OIM cluster IP patterns to wildcard subnets (x.x.x.*)
  ansible.builtin.set_fact:
    omnia_cluster_ip_patterns: >-
      {{
        (omnia_cluster_ip_patterns_raw | default([]))
        | map('regex_replace', '\\.[0-9]+$', '.*')
        | list
        | unique
      }}

- name: Build hostname wildcard patterns for k8s and slurm/login stacks
  ansible.builtin.set_fact:
    omnia_cluster_hostname_patterns: >-
      {{
        (
          (['service_kube*'] if (k8s_cluster_hostnames | length > 0) else [])
          +
          (['slurm-*', 'login-*', 'login_compiler-*'] if (slurm_cluster_hostnames | length > 0) else [])
        )
      }}

- name: Build combined OIM SSH match list (hostname patterns + IP wildcard patterns)
  ansible.builtin.set_fact:
    omnia_cluster_ssh_matches: >-
      {{
        (omnia_cluster_hostname_patterns + omnia_cluster_ip_patterns)
        | map('regex_replace', '\.[0-9]+$', '.*')
        | list
        | unique
      }}

- name: DEBUG OIM SSH match list
  ansible.builtin.debug:
    var: omnia_cluster_ssh_matches

- name: Manage /etc/hosts entries on OIM for Omnia cluster nodes
  ansible.builtin.blockinfile:
    path: /etc/hosts
    create: true
    mode: '0644'
    marker: "# {mark} OMNIA_CLUSTER_NODES"
    block: |
      {% for h in omnia_hosts_map | dict2items %}
      {{ h.value }} {{ h.key }}
      {% endfor %}
  when: omnia_hosts_map | default({}) | length > 0

- name: Configure SSH on OIM for passwordless access to all cluster nodes
  ansible.builtin.blockinfile:
    path: /root/.ssh/config
    create: true
    mode: '0600'
    marker: "# {mark} OMNIA_CLUSTER_SSH"
    block: |
      Host {{ omnia_cluster_ssh_matches
               | list
               | unique
               | join(' ') }}
          IdentityFile ~/.ssh/oim_rsa
          IdentitiesOnly yes

      Host *
          IdentityFile ~/.ssh/oim_rsa
          IdentitiesOnly yes
  when: omnia_cluster_ssh_matches | length > 0