# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
# tasks/build_host_lists.yml

- name: Set nodes.yaml path for passwordless SSH logic
  ansible.builtin.set_fact:
    omnia_nodes_yaml_path: "{{ hostvars['localhost']['oim_shared_path'] }}/omnia/openchami/workdir/nodes/nodes.yaml"

- name: Read nodes.yaml for group and host data
  ansible.builtin.slurp:
    src: "{{ omnia_nodes_yaml_path }}"
  register: omnia_nodes_yaml_raw

- name: Parse nodes.yaml content
  ansible.builtin.set_fact:
    omnia_nodes_data: "{{ omnia_nodes_yaml_raw.content | b64decode | from_yaml }}"

- name: Initialize per-stack hostname lists and IP wildcard patterns
  ansible.builtin.set_fact:
    k8s_cluster_hostnames: []
    slurm_cluster_hostnames: []
    k8s_cluster_ip_patterns: []
    slurm_cluster_ip_patterns: []
    omnia_cluster_ip_patterns: []
    omnia_hosts_map: {}

- name: Build per-stack hostname lists, IP wildcard patterns and hosts map from nodes.yaml
  ansible.builtin.set_fact:
    k8s_cluster_hostnames: >-
      {{
        (k8s_cluster_hostnames + [item.name])
        if item.group in k8s_functional_groups
        else k8s_cluster_hostnames
      }}
    slurm_cluster_hostnames: >-
      {{
        (slurm_cluster_hostnames + [item.name])
        if item.group in slurm_functional_groups
        else slurm_cluster_hostnames
      }}
    k8s_cluster_ip_patterns: >-
      {{
        (k8s_cluster_ip_patterns + [ (item.interfaces[0].ip_addrs[0].ip_addr | regex_replace('\\.[0-9]+$', '.*')) ])
        if (
          item.interfaces | length > 0 and
          item.interfaces[0].ip_addrs | length > 0 and
          item.group in k8s_functional_groups
        )
        else k8s_cluster_ip_patterns
      }}
    slurm_cluster_ip_patterns: >-
      {{
        (slurm_cluster_ip_patterns + [ (item.interfaces[0].ip_addrs[0].ip_addr | regex_replace('\\.[0-9]+$', '.*')) ])
        if (
          item.interfaces | length > 0 and
          item.interfaces[0].ip_addrs | length > 0 and
          item.group in slurm_functional_groups
        )
        else slurm_cluster_ip_patterns
      }}
    omnia_cluster_ip_patterns: >-
      {{
        (omnia_cluster_ip_patterns + [ (item.interfaces[0].ip_addrs[0].ip_addr | regex_replace('\\.[0-9]+$', '.*')) ])
        if (
          item.interfaces | length > 0 and
          item.interfaces[0].ip_addrs | length > 0
        )
        else omnia_cluster_ip_patterns
      }}
    omnia_hosts_map: >-
      {{
        (omnia_hosts_map | default({}))
        | combine(
            ({ (item.name): item.interfaces[0].ip_addrs[0].ip_addr }
             if (
               item.name | default('') | length > 0 and
               item.interfaces | length > 0 and
               item.interfaces[0].ip_addrs | length > 0
             )
             else {}),
            recursive=False
          )
      }}
  loop: "{{ omnia_nodes_data.nodes | default([]) }}"
  loop_control:
    label: "{{ item.group }} -> {{ item.name }} ({{ (item.interfaces[0].ip_addrs[0].ip_addr | default('no-ip')) if (item.interfaces | length > 0 and item.interfaces[0].ip_addrs | length > 0) else 'no-ip' }} )"

- name: Deduplicate host lists and IP wildcard patterns
  ansible.builtin.set_fact:
    k8s_cluster_hostnames: "{{ k8s_cluster_hostnames | unique }}"
    slurm_cluster_hostnames: "{{ slurm_cluster_hostnames | unique }}"
    k8s_cluster_ip_patterns: >-
      {{
        (k8s_cluster_ip_patterns | default([]))
        | map('regex_replace', '\\.[0-9]+$', '.*')
        | list
        | unique
      }}
    slurm_cluster_ip_patterns: >-
      {{
        (slurm_cluster_ip_patterns | default([]))
        | map('regex_replace', '\\.[0-9]+$', '.*')
        | list
        | unique
      }}
    omnia_cluster_ip_patterns: >-
      {{
        (omnia_cluster_ip_patterns | default([]))
        | map('regex_replace', '\\.[0-9]+$', '.*')
        | list
        | unique
      }}

- name: Build per-stack hostname wildcard patterns from nodes.yaml hostnames
  ansible.builtin.set_fact:
    k8s_cluster_hostname_patterns: >-
      {{
        (k8s_cluster_hostnames | default([]))
        | map('regex_replace', '[0-9]+$', '*')
        | list
        | unique
      }}
    slurm_cluster_hostname_patterns: >-
      {{
        (slurm_cluster_hostnames | default([]))
        | map('regex_replace', '[0-9]+$', '*')
        | list
        | unique
      }}

- name: Collect unique groups from nodes.yaml
  ansible.builtin.set_fact:
    omnia_nodes_groups: >-
      {{
        (omnia_nodes_data.nodes | default([]))
        | map(attribute='group')
        | list
        | unique
      }}

- name: Determine passwordless SSH mode based on required groups presence
  ansible.builtin.set_fact:
    omnia_required_groups_missing: >-
      {{
        omnia_required_groups
        | difference(omnia_nodes_groups | default([]))
      }}
    omnia_passwordless_mode: >-
      {{
        'host_star'
        if (omnia_required_groups_missing | length == 0)
        else 'derived'
      }}

- name: Build hostname and IP wildcard patterns from nodes.yaml when groups are incomplete
  ansible.builtin.set_fact:
    omnia_nodes_hostname_patterns: >-
      {{
        (omnia_nodes_data.nodes | default([]))
        | map(attribute='name')
        | map('regex_replace', '[0-9]+$', '*')
        | list
        | unique
      }}
    omnia_nodes_ip_patterns: >-
      {{
        (omnia_nodes_data.nodes | default([]))
        | map(attribute='interfaces')
        | map('first')
        | map(attribute='ip_addrs')
        | map('first')
        | map(attribute='ip_addr')
        | map('regex_replace', '\\.[0-9]+$', '.*')
        | list
        | unique
      }}
  when: omnia_passwordless_mode == 'derived'