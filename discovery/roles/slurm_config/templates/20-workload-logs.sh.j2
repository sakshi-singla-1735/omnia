#!/bin/bash
set -euo pipefail

{% if slurm_workloads_logs_path is defined %}

BASE_DIR="{{ slurm_workloads_logs_path }}"
USER="${SLURM_JOB_USER}"
JOB_ID="${SLURM_JOB_ID}"

JOB_DIR="${BASE_DIR}/${USER}/${JOB_ID}"

mkdir -p "${JOB_DIR}"
mkdir -p "${JOB_DIR}/images"
mkdir -p "${JOB_DIR}/tmp"

chown -R "${USER}:${USER}" "${JOB_DIR}"
chmod 700 "${JOB_DIR}"

# Enforce job working directory
cd "${JOB_DIR}"

# Enforce stdout / stderr
export SLURM_STDOUT="${JOB_DIR}/slurm.out"
export SLURM_STDERR="${JOB_DIR}/slurm.err"

# Enforce temp and image locations
export TMPDIR="${JOB_DIR}/tmp"
export SLURM_JOB_WORK_DIR="${JOB_DIR}"

{% endif %}
