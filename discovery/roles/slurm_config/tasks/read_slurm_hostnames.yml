#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---
- name: Slurp remote YAML file
  ansible.builtin.slurp:
    src: "{{ nodes_yaml }}"
  register: slurped_yaml

- name: Parse YAML into vars
  ansible.builtin.set_fact:
    node_yaml: "{{ slurped_yaml.content | b64decode | from_yaml }}"

- name: Read the node name group
  ansible.builtin.set_fact:
    name_group_map: "{{ node_yaml.nodes | items2dict(key_name='name', value_name='group') }}"

- name: Group the functional_groups
  ansible.builtin.set_fact:
    tmp_grouped_nodes: "{{ name_group_map | dict2items | groupby('value') }}"

- name: Re-organize the groups
  ansible.builtin.set_fact:
    grouped_nodes: "{{ grouped_nodes | default({}) | combine({item[0]: ((item[1] | items2dict).keys() | list)}) }}"
  loop: "{{ tmp_grouped_nodes }}"

- name: Get name and IP mapping 1
  ansible.builtin.set_fact:
    tmp_ip_name_map: "{{ node_yaml.nodes | items2dict(key_name='name', value_name='interfaces') }}"

- name: Get name and IP mapping 2
  ansible.builtin.set_fact:
    ip_name_map: "{{ ip_name_map | default({}) | combine({item.key: item.value[0]['ip_addrs'][0]['ip_addr']}) }}"
  loop: "{{ tmp_ip_name_map | dict2items }}"

- name: Get bmc_ip
  ansible.builtin.set_fact:
    bmc_ip_map: "{{ node_yaml.nodes | items2dict(key_name='name', value_name='bmc_ip') }}"

- name: Assign slurm lists
  ansible.builtin.set_fact:
    ctld_list: "{{ grouped_nodes | dict2items
                   | selectattr('key', 'match', '^' ~ 'slurm_control_node_')
                   | map(attribute='value') | list | flatten }}"
    dbd_list: "{{ grouped_nodes | dict2items
                   | selectattr('key', 'match', '^' ~ 'slurm_control_node_')
                   | map(attribute='value') | list | flatten }}"
    cmpt_list: "{{ grouped_nodes | dict2items
                   | selectattr('key', 'match', '^' ~ 'slurm_node_')
                   | map(attribute='value') | list | flatten }}"
    login_list: "{{ grouped_nodes | dict2items
                   | selectattr('key', 'match', '^' ~ 'login_node_')
                   | map(attribute='value') | list | flatten }}"
    compiler_login_list: "{{ grouped_nodes | dict2items
                   | selectattr('key', 'match', '^login_compiler_node_')
                   | map(attribute='value') | list | flatten }}"

- name: Fail if Slurm controller list is empty
  ansible.builtin.fail:
    msg: "{{ controller_empty_msg }}"
  when:
    - ctld_list | length == 0

- name: Extract slurm controller IP
  ansible.builtin.set_fact:
    controller_ip: "{{ ip_name_map[ctld_list | first] }}"
  when: ctld_list | length > 0
