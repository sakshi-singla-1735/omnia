# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---

- name: Delete temp_mapping_file
  ansible.builtin.file:
    path: "{{ temp_pxe_file_path }}"
    state: absent

- name: Remove leading/trailing spaces and tabs from the mapping file (but preserve column structure)
  ansible.builtin.shell: |
    set -o pipefail && \
    sed 's/^[[:space:]]*//g' "{{ pxe_mapping_file_path }}" | sed 's/[[:space:]]*$//g' > "{{ temp_pxe_file_path }}"
  changed_when: false
  failed_when: false

- name: Find and Replace
  ansible.builtin.lineinfile:
    path: "{{ temp_pxe_file_path }}"
    regexp: '\s*#'
    state: absent

- name: Read mapping file
  ansible.builtin.slurp:
    path: "{{ temp_pxe_file_path }}"
  register: mapping_file_raw

- name: Replace only the first occurrence (Jinja split+join)
  ansible.builtin.set_fact:
    modified_mapping_file: >-
      {{
        (mapping_file_raw.content | b64decode)
        .split('service_kube_control_plane_x86_64', 1)
        | join('service_kube_control_plane_first_x86_64')
      }}

- name: Write updated mapping file back to disk
  ansible.builtin.copy:
    content: "{{ modified_mapping_file }}"
    dest: "{{ temp_pxe_file_path }}"
    mode: "0644"

- name: Generate xnames in temporary mapping file
  generate_xname_in_mapping_file:
    mapping_file_path: "{{ temp_pxe_file_path }}"

- name: Read host mapping file from CSV file and return a dictionary
  community.general.read_csv:
    path: "{{ temp_pxe_file_path }}"
    key: "{{ mapping_file_key }}"
  register: read_mapping_file

- name: Initialize count variables
  ansible.builtin.set_fact:
    list_of_hostnames: []
    count_total_items: "{{ read_mapping_file.dict | length }}"

- name: Create list of hostnames defined in mapping file
  ansible.builtin.set_fact:
    list_of_hostnames: "{{ [item.value.HOSTNAME] + list_of_hostnames }}"
  loop: "{{ read_mapping_file.dict | dict2items }}"
  loop_control:
    label: "{{ item.value.ADMIN_MAC }}"

- name: Assert hostnames
  ansible.builtin.assert:
    that:
      - '"_" not in item'
      - '"." not in item'
      - '" " not in item'
    quiet: true
    fail_msg: "{{ hostname_chars_fail_msg + item }}"
  with_items: "{{ list_of_hostnames }}"

- name: Validate capital case in hostname
  ansible.builtin.assert:
    that: item is regex(("^(([a-z]|[a-z][a-z0-9\-]*[a-z0-9])\.)*([a-z]|[a-z][a-z0-9\-]*[a-z0-9])$"))
    fail_msg: "{{ capital_hostname_fail_msg }}"
  with_items: "{{ list_of_hostnames }}"
