#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
---
- name: Include storage_config.yml file
  ansible.builtin.include_vars: "{{ storage_config_vars }}"

- name: Load software_config.json as software_config
  ansible.builtin.include_vars:
    file: "{{ software_config_file }}"
    name: software_config

- name: Check if slurm support is true
  ansible.builtin.set_fact:
    slurm_support: "{{ software_config.softwares | selectattr('name', 'in', ['slurm', 'slurm_custom']) | list | length > 0 }}"

- name: Check if service_k8s support is true
  ansible.builtin.set_fact:
    service_k8s_support: "{{ software_config.softwares | selectattr('name', 'in', ['service_k8s']) | list | length > 0 }}"

- name: Block for filtering slurm mounts
  when: ('slurm' in omnia_run_tags) and (slurm_support)
  block:
    - name: Include omnia_config
      ansible.builtin.include_vars:
        file: "{{ omnia_config_vars }}"
        name: omnia_config

    - name: Set facts for slurm
      ansible.builtin.set_fact:
        filter_slurm_nfs: "{{ omnia_config.slurm_cluster | map(attribute='nfs_storage_name') | list }}"

    - name: Select the nfs client parameters for slurm
      ansible.builtin.set_fact:
        slurm_nfs: "{{ nfs_client_params | selectattr('nfs_name', 'in', filter_slurm_nfs) | list }}"

    - name: Add the slurm nfs
      ansible.builtin.set_fact:
        storage_to_be_mounted: "{{ storage_to_be_mounted + slurm_nfs }}"

- name: Block for filtering service_k8s mounts
  when: ('service_k8s' in omnia_run_tags) and (service_k8s_support)
  block:
    - name: Include omnia_config
      ansible.builtin.include_vars:
        file: "{{ omnia_config_vars }}"
        name: omnia_config

    - name: Set facts for service_k8s
      ansible.builtin.set_fact:
        filter_service_k8s_nfs: "{{ omnia_config.service_k8s_cluster | map(attribute='nfs_storage_name') | list }}"

    - name: Select the nfs client parameters for service_k8s
      ansible.builtin.set_fact:
        service_k8s_nfs: "{{ nfs_client_params | selectattr('nfs_name', 'in', filter_service_k8s_nfs) | list }}"

    - name: Add the service_k8s nfs
      ansible.builtin.set_fact:
        storage_to_be_mounted: "{{ storage_to_be_mounted + service_k8s_nfs }}"

- name: Print nfs_storage_name
  ansible.builtin.debug:
    msg: "{{ storage_to_be_mounted }}"

- name: Install NFS client with bolt-on support
  ansible.builtin.include_tasks: nfs_client.yml
  with_items: "{{ storage_to_be_mounted }}"
