#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

apiVersion: v1
kind: Service
metadata:
  name: "{{ idrac_telemetry_service_name }}"
  namespace: "{{ telemetry_namespace }}"
  labels:
    app: "{{ idrac_telemetry_service_name }}"
spec:
  clusterIP: None
  ports:
    - name: mysql-port-1
      port: {{ mysqldb_container_port1 }}
    - name: mysql-port-2
      port: {{ mysqldb_container_port2 }}
  selector:
    app: "{{ idrac_telemetry_k8s_name }}"
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ idrac_telemetry_k8s_name }}
  namespace: {{ telemetry_namespace }}
spec:
  podManagementPolicy: Parallel
  serviceName: {{ idrac_telemetry_service_name }}
  replicas: 1
  selector:
    matchLabels:
      app: {{ idrac_telemetry_k8s_name }}
  template:
    metadata:
      labels:
        app: {{ idrac_telemetry_k8s_name }}
    spec:
      volumes:
{% set types = hostvars['localhost']['idrac_telemetry_collection_type'].split(',') %}
{% if 'kafka' in types %}
        # Mount Kafka cluster CA certificate for TLS verification
        - name: kafka-cluster-ca-cert
          secret:
            secretName: kafka-cluster-ca-cert
            items:
              - key: ca.crt
                path: ca.crt
        # Mount kafkapump user certificates for mTLS authentication
        - name: kafkapump-user-certs
          secret:
            secretName: kafkapump
            items:
              - key: user.crt
                path: user.crt
              - key: user.key
                path: user.key
              - key: ca.crt
                path: ca.crt
{% endif %}
      hostAliases:
        - ip: "127.0.0.1"
          hostnames:
            - "mysqldb"
      terminationGracePeriodSeconds: 10
      tolerations:
      - effect: NoExecute
        key: node.kubernetes.io/not-ready
        operator: Exists
        tolerationSeconds: 5
      - effect: NoExecute
        key: node.kubernetes.io/unreachable
        operator: Exists
        tolerationSeconds: 5
      initContainers:
        # Clean up stale MySQL lock files from previous ungraceful shutdowns
        - name: cleanup-mysql-locks
          image: {{ mysql_image }}
          command:
            - /bin/sh
            - -c
            - |
              echo "Checking for stale MySQL lock files..."
              rm -f /var/lib/mysql/*.sock /var/lib/mysql/*.pid 2>/dev/null || true
              echo "Lock file cleanup complete"
          volumeMounts:
            - name: mysqldb-pvc
              mountPath: /var/lib/mysql/
      containers:
        - name: mysqldb
          image: {{ mysql_image }}
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: mysqldb-pvc
              mountPath: /var/lib/mysql/
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "mysqladmin shutdown -uroot -p${MYSQL_ROOT_PASSWORD} 2>/dev/null || true"]
          env:
            - name: MYSQL_DATABASE
              value: {{ mysqldb_name }}
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: {{ mysqldb_secrets_name }}
                  key: mysqldb_user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ mysqldb_secrets_name }}
                  key: mysqldb_password
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ mysqldb_secrets_name }}
                  key: mysqldb_root_password
          ports:
            - containerPort: {{ mysqldb_container_port1 }}
            - containerPort: {{ mysqldb_container_port2 }}

        - name: activemq
          image: {{ activemq_image }}
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: {{ activemq_http_port_1 }}
            - containerPort: {{ activemq_http_port_2 }}

        - name: idrac-telemetry-receiver
          image: {{ idrac_telemetry_receiver_image }}
          imagePullPolicy: IfNotPresent
          env:
            - name: MESSAGEBUS_HOST
              value: 127.0.0.1
            - name: MESSAGEBUS_PORT
              value: "{{ messagebus_http_port }}"
            - name: CONFIGUI_HTTP_PORT
              value: "{{ configui_http_port }}"
            - name: MYSQL_DATABASE
              value: {{ mysqldb_name }}
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: {{ mysqldb_secrets_name }}
                  key: mysqldb_user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ mysqldb_secrets_name }}
                  key: mysqldb_password
            - name: MYSQL_HOST
              value: mysqldb
            - name: MYSQL_HOST_PORT
              value: "{{ mysqldb_container_port1 }}"

{% if 'kafka' in types %}
        - name: kafka-pump
          image: {{ kafkapump_image }}
          imagePullPolicy: IfNotPresent
          volumeMounts:
            # Mount kafkapump user certificates for mTLS (under /extrabin/certs/)
            - mountPath: /extrabin/certs/kafka-certs
              name: kafkapump-user-certs
              readOnly: true
            # Mount cluster CA certificate (under /extrabin/certs/)
            - mountPath: /extrabin/certs/cluster-ca
              name: kafka-cluster-ca-cert
              readOnly: true
          env:
            - name: MESSAGEBUS_HOST
              value: 127.0.0.1
            - name: MESSAGEBUS_PORT
              value: "{{ messagebus_http_port }}"
            - name: KAFKA_BROKER
              value: "kafka-kafka-bootstrap.telemetry.svc.cluster.local:9093"
            - name: KAFKA_TOPIC
              value: "{{ kafka.topics.idrac.name }}"
            # TLS configuration - using iDRAC Telemetry Reference Tools standard env var names
            # Note: kafkapump prepends /extrabin/certs/ to these paths, so use relative paths
            - name: KAFKA_CACERT
              value: "cluster-ca/ca.crt"
            - name: KAFKA_CLIENT_CERT
              value: "kafka-certs/user.crt"
            - name: KAFKA_CLIENT_KEY
              value: "kafka-certs/user.key"
            - name: KAFKA_SKIP_VERIFY
              value: "false"
            - name: KAFKA_PARTITION
              value: "0"
{% endif %}

{% if 'victoria' in types %}
        - name: victoria-pump
          image: {{ victoriapump_image }}
          imagePullPolicy: IfNotPresent
          env:
            - name: MESSAGEBUS_HOST
              value: 127.0.0.1
            - name: MESSAGEBUS_PORT
              value: "{{ messagebus_http_port }}"
            - name: MESSAGEBUS_TYPE
              value: stomp
          ports:
            - containerPort: 2112
              name: victoriapump
{% endif %}

  volumeClaimTemplates:
    - metadata:
        name: mysqldb-pvc
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: {{ mysqldb_storage }}
