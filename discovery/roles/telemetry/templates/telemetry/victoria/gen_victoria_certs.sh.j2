#!/bin/bash
#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

# Generate TLS certificates for VictoriaMetrics

set -e

CERT_DIR="{{ victoria_cert_dir }}"
CA_KEY="$CERT_DIR/ca.key"
CA_CERT="$CERT_DIR/ca.crt"
CERT_KEY="$CERT_DIR/server.key"
CERT_FILE="$CERT_DIR/server.crt"
CSR_FILE="$CERT_DIR/server.csr"
SAN_CONFIG="$CERT_DIR/san.cnf"

mkdir -p "$CERT_DIR"

# Create SAN configuration
cat > "$SAN_CONFIG" <<EOF
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
CN = victoria-loadbalancer.{{ telemetry_namespace }}.svc.cluster.local

[v3_req]
keyUsage = keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
# Single-node deployment names
DNS.1 = victoria-loadbalancer
DNS.2 = victoria-loadbalancer.{{ telemetry_namespace }}
DNS.3 = victoria-loadbalancer.{{ telemetry_namespace }}.svc
DNS.4 = victoria-loadbalancer.{{ telemetry_namespace }}.svc.cluster.local
DNS.5 = victoria-metric-0
DNS.6 = victoria-metric-0.{{ telemetry_namespace }}
DNS.7 = victoria-metric-0.{{ telemetry_namespace }}.svc
DNS.8 = victoria-metric-0.{{ telemetry_namespace }}.svc.cluster.local
# Cluster deployment names
DNS.9 = vminsert
DNS.10 = vminsert.{{ telemetry_namespace }}
DNS.11 = vminsert.{{ telemetry_namespace }}.svc
DNS.12 = vminsert.{{ telemetry_namespace }}.svc.cluster.local
DNS.13 = vmselect
DNS.14 = vmselect.{{ telemetry_namespace }}
DNS.15 = vmselect.{{ telemetry_namespace }}.svc
DNS.16 = vmselect.{{ telemetry_namespace }}.svc.cluster.local
DNS.17 = vmstorage
DNS.18 = vmstorage.{{ telemetry_namespace }}
DNS.19 = vmstorage.{{ telemetry_namespace }}.svc
DNS.20 = vmstorage.{{ telemetry_namespace }}.svc.cluster.local
# VMStorage StatefulSet pods
DNS.21 = vmstorage-0.vmstorage.{{ telemetry_namespace }}.svc.cluster.local
DNS.22 = vmstorage-1.vmstorage.{{ telemetry_namespace }}.svc.cluster.local
DNS.23 = vmstorage-2.vmstorage.{{ telemetry_namespace }}.svc.cluster.local
IP.1 = 127.0.0.1
EOF

# Generate CA key
if [ ! -f "$CA_KEY" ]; then
  echo "Generating CA key..."
  openssl genrsa -out "$CA_KEY" 4096
fi

# Generate CA certificate
if [ ! -f "$CA_CERT" ]; then
  echo "Generating CA certificate..."
  openssl req -x509 -new -nodes \
    -key "$CA_KEY" \
    -out "$CA_CERT" \
    -days {{ victoria_tls_cert_days | default(3650) }} \
    -subj "/CN=VictoriaMetrics-CA"
fi

# Generate Victoria server private key
if [ ! -f "$CERT_KEY" ]; then
  echo "Generating VictoriaMetrics server key..."
  openssl genrsa -out "$CERT_KEY" 4096
fi

# Generate CSR
if [ ! -f "$CSR_FILE" ]; then
  echo "Generating certificate signing request..."
  openssl req -new -key "$CERT_KEY" \
    -out "$CSR_FILE" \
    -config "$SAN_CONFIG"
fi

# Sign certificate
if [ ! -f "$CERT_FILE" ]; then
  echo "Signing server certificate..."
  openssl x509 -req \
    -in "$CSR_FILE" \
    -CA "$CA_CERT" \
    -CAkey "$CA_KEY" \
    -CAcreateserial \
    -out "$CERT_FILE" \
    -days {{ victoria_tls_cert_days | default(3650) }} \
    -sha256 \
    -extensions v3_req \
    -extfile "$SAN_CONFIG"
fi

echo "Certificates generated successfully in $CERT_DIR"
echo "Files:"
echo "  CA Certificate: $CA_CERT"
echo "  Server Certificate: $CERT_FILE"
echo "  Server Key: $CERT_KEY"

# Verify certificate
echo ""
echo "Certificate details:"
openssl x509 -in "$CERT_FILE" -text -noout | grep -A1 "Subject:"
openssl x509 -in "$CERT_FILE" -text -noout | grep -A10 "Subject Alternative Name"
