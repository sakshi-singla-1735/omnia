#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ vmagent.configmap_name }}"
  namespace: "{{ telemetry_namespace }}"
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ vmagent.global.scrape_interval }}

    scrape_configs:
      - job_name: "{{ vmagent.job_name }}"
        honor_labels: true

        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - {{ vmagent.kubernetes_sd_namespace }}

        relabel_configs:

          # Keep only pods with correct label
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: {{ vmagent.target_pod_label }}
            action: keep

          # Keep only the metrics container
          - source_labels: [__meta_kubernetes_pod_container_name]
            regex: {{ vmagent.metrics_container_name }}
            action: keep

          # Set actual scrape address (container port)
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: __address__
            replacement: "$1:{{ vmagent.metrics_port }}"

          # Unique instance using pod name
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: instance

          # Add namespace label
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace

          # Add Pod IP label
          - source_labels: [__meta_kubernetes_pod_ip]
            target_label: pod_ip