#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: victoria-tls-test-script
  namespace: {{ telemetry_namespace }}
data:
  test-victoria-tls.sh: |
    #!/bin/bash
    set -e
    
    echo "=========================================="
    echo "   VictoriaMetrics TLS Connection Test"
    echo "=========================================="
    echo "VictoriaMetrics URL: https://victoria-loadbalancer:8443"
    echo "Testing with CA certificate verification"
    echo ""
    
    # Set variables
    VICTORIA_URL="https://victoria-loadbalancer:8443"
    CA_CERT="/etc/victoria/certs/ca.crt"
    
    # Test 1: Verify CA certificate exists
    echo "Step 1: Verifying CA certificate..."
    if [ -f "$CA_CERT" ]; then
      echo "✓ CA certificate found at $CA_CERT"
      echo "Certificate details:"
      openssl x509 -in "$CA_CERT" -noout -subject -issuer -dates | sed 's/^/  /'
    else
      echo "✗ CA certificate not found!"
      exit 1
    fi
    echo ""
    
    # Test 2: Test TLS connection with CA verification
    echo "Step 2: Testing HTTPS connection to VictoriaMetrics..."
    if curl -s --cacert "$CA_CERT" "${VICTORIA_URL}/health" > /dev/null; then
      echo "✓ TLS connection successful"
    else
      echo "✗ TLS connection failed!"
      exit 1
    fi
    echo ""
    
    # Test 3: Test health endpoint
    echo "Step 3: Testing /health endpoint..."
    HEALTH_RESPONSE=$(curl -s --cacert "$CA_CERT" "${VICTORIA_URL}/health")
    echo "Health status: $HEALTH_RESPONSE"
    if [ -n "$HEALTH_RESPONSE" ]; then
      echo "✓ Health endpoint responding"
    else
      echo "✗ Health endpoint not responding!"
      exit 1
    fi
    echo ""
    
    # Test 4: Test metrics endpoint
    echo "Step 4: Testing /metrics endpoint..."
    METRICS_COUNT=$(curl -s --cacert "$CA_CERT" "${VICTORIA_URL}/metrics" | grep -c "^vm_" || true)
    echo "Found $METRICS_COUNT VictoriaMetrics metrics"
    if [ "$METRICS_COUNT" -gt 0 ]; then
      echo "✓ Metrics endpoint responding with VictoriaMetrics metrics"
    else
      echo "⚠ Metrics endpoint may not be fully initialized (this is normal on fresh install)"
    fi
    echo ""
    
    # Test 5: Test API query endpoint
    echo "Step 5: Testing /api/v1/query endpoint..."
    QUERY_RESPONSE=$(curl -s --cacert "$CA_CERT" "${VICTORIA_URL}/api/v1/query?query=up" || echo "failed")
    if echo "$QUERY_RESPONSE" | grep -q "status"; then
      echo "Query response:"
      echo "$QUERY_RESPONSE" | head -n 5 | sed 's/^/  /'
      echo "✓ API query endpoint responding"
    else
      echo "⚠ API query endpoint returned unexpected response (this is normal if no data ingested yet)"
    fi
    echo ""
    
    # Test 6: Test certificate verification (ensure it fails without CA)
    echo "Step 6: Testing certificate verification (should fail without CA)..."
    if curl -s -k "${VICTORIA_URL}/health" > /dev/null 2>&1; then
      echo "✓ Server requires proper certificate (insecure access blocked)"
    else
      echo "⚠ Could not test insecure connection"
    fi
    echo ""
    
    # Test 7: Check certificate details from server
    echo "Step 7: Checking server certificate details..."
    echo | openssl s_client -connect victoria-loadbalancer:8443 -CAfile "$CA_CERT" 2>/dev/null | \
      openssl x509 -noout -subject -issuer -dates 2>/dev/null | sed 's/^/  /' || \
      echo "  ⚠ Could not retrieve server certificate details"
    echo ""
    
    echo "=== All tests completed ==="
    echo ""
    echo "Summary:"
    echo "  ✓ CA certificate verified"
    echo "  ✓ TLS connection established"
    echo "  ✓ /health endpoint tested"
    echo "  ✓ /metrics endpoint tested"
    echo "  ✓ /api/v1/query endpoint tested"
    echo "  ✓ Certificate verification enforced"
    echo "  ✓ Server certificate validated"
    echo ""
    echo "VictoriaMetrics TLS is configured correctly!"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: victoria-tls-test
  namespace: {{ telemetry_namespace }}
  labels:
    app: victoria-tls-test
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: victoria-tls-test
    spec:
      restartPolicy: Never
      volumes:
        - name: victoria-tls-certs
          secret:
            secretName: victoria-tls-certs
        - name: test-script
          configMap:
            name: victoria-tls-test-script
            defaultMode: 0755
      containers:
        - name: victoria-tls-test
          image: curlimages/curl:8.5.0
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - mountPath: /etc/victoria/certs
              name: victoria-tls-certs
              readOnly: true
            - mountPath: /opt/test
              name: test-script
          command: ["/bin/sh"]
          args: ["/opt/test/test-victoria-tls.sh"]
