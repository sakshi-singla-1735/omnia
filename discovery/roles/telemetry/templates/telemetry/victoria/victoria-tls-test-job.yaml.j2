#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: victoria-tls-test-script
  namespace: {{ telemetry_namespace }}
data:
  test-victoria-tls.sh: |
    #!/bin/bash
    set -e
    
    echo "=========================================="
    echo "   VictoriaMetrics TLS Connection Test"
    echo "=========================================="
{% if hostvars['localhost']['victoria_configurations']['deployment_mode'] == 'cluster' %}
    echo "Deployment Mode: Cluster"
{% if victoria_cluster.tls_enabled %}
    echo "VictoriaMetrics URL: https://vmselect:8481"
    echo "Testing with CA certificate verification"
    VICTORIA_URL="https://vmselect:8481"
    CA_CERT="/etc/victoria/certs/ca.crt"
    USE_TLS="true"
{% else %}
    echo "VictoriaMetrics URL: http://vmselect:8481"
    echo "Testing cluster without TLS (HTTP)"
    VICTORIA_URL="http://vmselect:8481"
    CA_CERT=""
    USE_TLS="false"
{% endif %}
{% else %}
    echo "Deployment Mode: Single-Node"
    echo "VictoriaMetrics URL: https://victoria-loadbalancer:8443"
    echo "Testing with CA certificate verification"
    VICTORIA_URL="https://victoria-loadbalancer:8443"
    CA_CERT="/etc/victoria/certs/ca.crt"
    USE_TLS="true"
{% endif %}
    echo ""
    
    # Set variables based on deployment mode
    # VICTORIA_URL and CA_CERT already set above
    
    # Test 1: Verify CA certificate exists (only for TLS)
    if [ "$USE_TLS" = "true" ]; then
      echo "Step 1: Verifying CA certificate..."
      if [ -f "$CA_CERT" ]; then
        echo "✓ CA certificate found at $CA_CERT"
        if command -v openssl > /dev/null 2>&1; then
          echo "Certificate details:"
          openssl x509 -in "$CA_CERT" -noout -subject -issuer -dates 2>/dev/null | sed 's/^/  /' || echo "  (Certificate details not available)"
        fi
      else
        echo "✗ CA certificate not found!"
        exit 1
      fi
      echo ""
    else
      echo "Step 1: Skipping certificate verification (TLS not enabled)"
      echo ""
    fi
    
    # Test 2: Test connection
    if [ "$USE_TLS" = "true" ]; then
      echo "Step 2: Testing HTTPS connection to VictoriaMetrics..."
      if curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/health" > /dev/null; then
        echo "✓ TLS connection successful"
      else
        echo "✗ TLS connection failed!"
        exit 1
      fi
    else
      echo "Step 2: Testing HTTP connection to VictoriaMetrics..."
      if curl -s --max-time 30 "${VICTORIA_URL}/health" > /dev/null; then
        echo "✓ HTTP connection successful"
      else
        echo "✗ HTTP connection failed!"
        exit 1
      fi
    fi
    echo ""
    
    # Test 3: Test health endpoint
    echo "Step 3: Testing /health endpoint..."
    if [ "$USE_TLS" = "true" ]; then
      HEALTH_RESPONSE=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/health")
    else
      HEALTH_RESPONSE=$(curl -s --max-time 30 "${VICTORIA_URL}/health")
    fi
    echo "Health status: $HEALTH_RESPONSE"
    if [ -n "$HEALTH_RESPONSE" ]; then
      echo "✓ Health endpoint responding"
    else
      echo "✗ Health endpoint not responding!"
      exit 1
    fi
    echo ""
    
    # Test 4: Test metrics endpoint
    echo "Step 4: Testing /metrics endpoint..."
    if [ "$USE_TLS" = "true" ]; then
      METRICS_COUNT=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/metrics" | grep -c "^vm_" || true)
    else
      METRICS_COUNT=$(curl -s --max-time 30 "${VICTORIA_URL}/metrics" | grep -c "^vm_" || true)
    fi
    echo "Found $METRICS_COUNT VictoriaMetrics metrics"
    if [ "$METRICS_COUNT" -gt 0 ]; then
      echo "✓ Metrics endpoint responding with VictoriaMetrics metrics"
    else
      echo "⚠ Metrics endpoint may not be fully initialized (this is normal on fresh install)"
    fi
    echo ""
    
    # Test 5: Test API query endpoint
{% if hostvars['localhost']['victoria_configurations']['deployment_mode'] == 'cluster' %}
    echo "Step 5: Testing /select/0/prometheus/api/v1/query endpoint..."
    if [ "$USE_TLS" = "true" ]; then
      QUERY_RESPONSE=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/select/0/prometheus/api/v1/query?query=up" || echo "failed")
    else
      QUERY_RESPONSE=$(curl -s --max-time 30 "${VICTORIA_URL}/select/0/prometheus/api/v1/query?query=up" || echo "failed")
    fi
    if echo "$QUERY_RESPONSE" | grep -q "status"; then
      echo "Query response:"
      echo "$QUERY_RESPONSE" | head -n 5 | sed 's/^/  /'
      echo "✓ API query endpoint responding"
    else
      echo "⚠ API query endpoint returned unexpected response (this is normal if no data ingested yet)"
      echo "Response: $QUERY_RESPONSE"
    fi
    echo ""
    
    # Test 5.1: List all available metric names
    echo "Step 5.1: Listing all available metric names..."
    if [ "$USE_TLS" = "true" ]; then
      METRIC_NAMES=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/select/0/prometheus/api/v1/label/__name__/values" || echo "failed")
    else
      METRIC_NAMES=$(curl -s --max-time 30 "${VICTORIA_URL}/select/0/prometheus/api/v1/label/__name__/values" || echo "failed")
    fi
    
    if echo "$METRIC_NAMES" | grep -q "status"; then
      METRIC_COUNT=$(echo "$METRIC_NAMES" | grep -o '"[^"]*"' | wc -l || echo "0")
      echo "Found $METRIC_COUNT unique metric names:"
      echo "$METRIC_NAMES" | grep -o '"[^"]*"' | sed 's/"//g' | head -20 | sed 's/^/  /'
      if [ "$METRIC_COUNT" -gt 20 ]; then
        echo "  ... and $((METRIC_COUNT - 20)) more metrics"
      fi
      echo "✓ Metric names endpoint responding"
    else
      echo "⚠ No metrics found or endpoint not responding"
      echo "Response: $METRIC_NAMES"
    fi
    echo ""
    
    # Test 5.2: Query specific known metrics with data
    echo "Step 5.2: Testing specific telemetry metrics..."
    
    # Test PowerEdge CPU Temperature (known working metric)
    echo "Testing PowerEdge CPU Temperature..."
    if [ "$USE_TLS" = "true" ]; then
      TEMP_METRICS=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/select/0/prometheus/api/v1/query?query=PowerEdge_CPU1Temp_TemperatureReading" || echo "failed")
    else
      TEMP_METRICS=$(curl -s --max-time 30 "${VICTORIA_URL}/select/0/prometheus/api/v1/query?query=PowerEdge_CPU1Temp_TemperatureReading" || echo "failed")
    fi
    
    if echo "$TEMP_METRICS" | grep -q "status.*success"; then
      TEMP_COUNT=$(echo "$TEMP_METRICS" | grep -o '"metric":{[^}]*}' | wc -l || echo "0")
      echo "  Found $TEMP_COUNT CPU temperature readings:"
      if [ "$TEMP_COUNT" -gt 0 ]; then
        echo "$TEMP_METRICS" | grep -o '"HostName":"[^"]*"' | sed 's/"HostName":"//g; s/"//g' | sed 's/^/    Server: /'
        echo "$TEMP_METRICS" | grep -o '"value":\[[^]]*\]' | sed 's/"value":\[//g; s/\]//g' | sed 's/^/    Temperature: /' | sed 's/,/°C at timestamp /'
        echo "  ✓ PowerEdge temperature metrics active"
      else
        echo "  ⚠ No temperature data found"
      fi
    else
      echo "  ⚠ Could not query temperature metrics"
    fi
    echo ""
    
    # Test 'up' metric (service discovery)
    echo "Testing service discovery metrics..."
    if [ "$USE_TLS" = "true" ]; then
      UP_METRICS=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/select/0/prometheus/api/v1/query?query=up" || echo "failed")
    else
      UP_METRICS=$(curl -s --max-time 30 "${VICTORIA_URL}/select/0/prometheus/api/v1/query?query=up" || echo "failed")
    fi
    
    if echo "$UP_METRICS" | grep -q "status.*success"; then
      UP_COUNT=$(echo "$UP_METRICS" | grep -o '"metric":{[^}]*}' | wc -l || echo "0")
      echo "  Found $UP_COUNT active targets:"
      if [ "$UP_COUNT" -gt 0 ]; then
        echo "$UP_METRICS" | grep -o '"job":"[^"]*"' | sed 's/"job":"//g; s/"//g' | sort | uniq | sed 's/^/    Job: /'
        echo "  ✓ Service discovery metrics active"
      else
        echo "  ⚠ No service discovery data found"
      fi
    else
      echo "  ⚠ Could not query service discovery metrics"
    fi
    echo ""
{% else %}
    echo "Step 5: Testing /api/v1/query endpoint..."
    if [ "$USE_TLS" = "true" ]; then
      QUERY_RESPONSE=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/api/v1/query?query=up" || echo "failed")
    else
      QUERY_RESPONSE=$(curl -s --max-time 30 "${VICTORIA_URL}/api/v1/query?query=up" || echo "failed")
    fi
    if echo "$QUERY_RESPONSE" | grep -q "status"; then
      echo "Query response:"
      echo "$QUERY_RESPONSE" | head -n 5 | sed 's/^/  /'
      echo "✓ API query endpoint responding"
    else
      echo "⚠ API query endpoint returned unexpected response (this is normal if no data ingested yet)"
    fi
    echo ""
    
    # Test 5.1: List all available metric names
    echo "Step 5.1: Listing all available metric names..."
    if [ "$USE_TLS" = "true" ]; then
      METRIC_NAMES=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/api/v1/label/__name__/values" || echo "failed")
    else
      METRIC_NAMES=$(curl -s --max-time 30 "${VICTORIA_URL}/api/v1/label/__name__/values" || echo "failed")
    fi
    
    if echo "$METRIC_NAMES" | grep -q "status"; then
      METRIC_COUNT=$(echo "$METRIC_NAMES" | grep -o '"[^"]*"' | wc -l || echo "0")
      echo "Found $METRIC_COUNT unique metric names:"
      echo "$METRIC_NAMES" | grep -o '"[^"]*"' | sed 's/"//g' | head -20 | sed 's/^/  /'
      if [ "$METRIC_COUNT" -gt 20 ]; then
        echo "  ... and $((METRIC_COUNT - 20)) more metrics"
      fi
      echo "✓ Metric names endpoint responding"
    else
      echo "⚠ No metrics found or endpoint not responding"
      echo "Response: $METRIC_NAMES"
    fi
    echo ""
    
    # Test 5.2: Query specific known metrics with data
    echo "Step 5.2: Testing specific telemetry metrics..."
    
    # Test PowerEdge CPU Temperature (known working metric)
    echo "Testing PowerEdge CPU Temperature..."
    if [ "$USE_TLS" = "true" ]; then
      TEMP_METRICS=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/api/v1/query?query=PowerEdge_CPU1Temp_TemperatureReading" || echo "failed")
    else
      TEMP_METRICS=$(curl -s --max-time 30 "${VICTORIA_URL}/api/v1/query?query=PowerEdge_CPU1Temp_TemperatureReading" || echo "failed")
    fi
    
    if echo "$TEMP_METRICS" | grep -q "status.*success"; then
      TEMP_COUNT=$(echo "$TEMP_METRICS" | grep -o '"metric":{[^}]*}' | wc -l || echo "0")
      echo "  Found $TEMP_COUNT CPU temperature readings:"
      if [ "$TEMP_COUNT" -gt 0 ]; then
        echo "$TEMP_METRICS" | grep -o '"HostName":"[^"]*"' | sed 's/"HostName":"//g; s/"//g' | sed 's/^/    Server: /'
        echo "$TEMP_METRICS" | grep -o '"value":\[[^]]*\]' | sed 's/"value":\[//g; s/\]//g' | sed 's/^/    Temperature: /' | sed 's/,/°C at timestamp /'
        echo "  ✓ PowerEdge temperature metrics active"
      else
        echo "  ⚠ No temperature data found"
      fi
    else
      echo "  ⚠ Could not query temperature metrics"
    fi
    echo ""
    
    # Test 'up' metric (service discovery)
    echo "Testing service discovery metrics..."
    if [ "$USE_TLS" = "true" ]; then
      UP_METRICS=$(curl -s --max-time 30 --cacert "$CA_CERT" "${VICTORIA_URL}/api/v1/query?query=up" || echo "failed")
    else
      UP_METRICS=$(curl -s --max-time 30 "${VICTORIA_URL}/api/v1/query?query=up" || echo "failed")
    fi
    
    if echo "$UP_METRICS" | grep -q "status.*success"; then
      UP_COUNT=$(echo "$UP_METRICS" | grep -o '"metric":{[^}]*}' | wc -l || echo "0")
      echo "  Found $UP_COUNT active targets:"
      if [ "$UP_COUNT" -gt 0 ]; then
        echo "$UP_METRICS" | grep -o '"job":"[^"]*"' | sed 's/"job":"//g; s/"//g' | sort | uniq | sed 's/^/    Job: /'
        echo "  ✓ Service discovery metrics active"
      else
        echo "  ⚠ No service discovery data found"
      fi
    else
      echo "  ⚠ Could not query service discovery metrics"
    fi
    echo ""
{% endif %}
    
    # Test 6: Test certificate verification (only for TLS)
    if [ "$USE_TLS" = "true" ]; then
      echo "Step 6: Testing certificate verification (should fail without CA)..."
      if curl -s --max-time 30 -k "${VICTORIA_URL}/health" > /dev/null 2>&1; then
        echo "✓ Server requires proper certificate (insecure access blocked)"
      else
        echo "⚠ Could not test insecure connection"
      fi
      echo ""
    else
      echo "Step 6: Skipping certificate verification test (TLS not enabled)"
      echo ""
    fi
    
    # Test 7: Check certificate details from server (only for TLS)
    if [ "$USE_TLS" = "true" ]; then
      echo "Step 7: Checking server certificate details..."
      if command -v openssl > /dev/null 2>&1; then
{% if hostvars['localhost']['victoria_configurations']['deployment_mode'] == 'cluster' %}
        echo | openssl s_client -connect vmselect:8481 -CAfile "$CA_CERT" 2>/dev/null | \
          openssl x509 -noout -subject -issuer -dates 2>/dev/null | sed 's/^/  /' || \
          echo "  ⚠ Could not retrieve server certificate details"
{% else %}
        echo | openssl s_client -connect victoria-loadbalancer:8443 -CAfile "$CA_CERT" 2>/dev/null | \
          openssl x509 -noout -subject -issuer -dates 2>/dev/null | sed 's/^/  /' || \
          echo "  ⚠ Could not retrieve server certificate details"
{% endif %}
      else
        echo "  ℹ OpenSSL not available (certificate details skipped, but curl validated TLS successfully)"
      fi
      echo ""
    else
      echo "Step 7: Skipping server certificate check (TLS not enabled)"
      echo ""
    fi
    
    echo "=== All tests completed ==="
    echo ""
    echo "Summary:"
    if [ "$USE_TLS" = "true" ]; then
      echo "  ✓ CA certificate verified"
      echo "  ✓ TLS connection established"
      echo "  ✓ /health endpoint tested"
      echo "  ✓ /metrics endpoint tested"
      echo "  ✓ /api/v1/query endpoint tested"
      echo "  ✓ Certificate verification enforced"
      echo "  ✓ Server certificate validated"
      echo ""
      echo "VictoriaMetrics TLS is configured correctly!"
    else
      echo "  ✓ HTTP connection established"
      echo "  ✓ /health endpoint tested"
      echo "  ✓ /metrics endpoint tested"
      echo "  ✓ /api/v1/query endpoint tested"
      echo ""
      echo "VictoriaMetrics (without TLS) is configured correctly!"
    fi

---
apiVersion: batch/v1
kind: Job
metadata:
  name: victoria-tls-test
  namespace: {{ telemetry_namespace }}
  labels:
    app: victoria-tls-test
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: victoria-tls-test
    spec:
      restartPolicy: Never
      volumes:
{% if hostvars['localhost']['victoria_configurations']['deployment_mode'] == 'single-node' or victoria_cluster.tls_enabled %}
        - name: victoria-tls-certs
          secret:
            secretName: victoria-tls-certs
{% endif %}
        - name: test-script
          configMap:
            name: victoria-tls-test-script
            defaultMode: 0755
      containers:
        - name: victoria-tls-test
          image: curlimages/curl:8.17.0
          imagePullPolicy: IfNotPresent
          volumeMounts:
{% if hostvars['localhost']['victoria_configurations']['deployment_mode'] == 'single-node' or victoria_cluster.tls_enabled %}
            - mountPath: /etc/victoria/certs
              name: victoria-tls-certs
              readOnly: true
{% endif %}
            - mountPath: /opt/test
              name: test-script
          command: ["/bin/sh"]
          args: ["/opt/test/test-victoria-tls.sh"]
