#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: kafkapump
  namespace: {{ telemetry_namespace }}
  labels:
    strimzi.io/cluster: kafka
spec:
  authentication:
    type: tls
  authorization:
    type: simple
    acls:
{% if hostvars['localhost']['idrac_telemetry_support'] and 'kafka' in hostvars['localhost']['idrac_telemetry_collection_type'].split(',') %}
      # Producer permissions for idrac topic
      - resource:
          type: topic
          name: idrac
          patternType: literal
        operations:
          - Write
          - Create
          - Describe
          - Read
        host: "*"
      # Consumer group permissions for idrac
      - resource:
          type: group
          name: idrac-consumer-group
          patternType: prefix
        operations:
          - Read
        host: "*"
{% endif %}
{% if hostvars['localhost']['ldms_support'] %}
      # Producer permissions for ldms topic
      - resource:
          type: topic
          name: ldms
          patternType: literal
        operations:
          - Write
          - Create
          - Describe
          - Read
        host: "*"
      # Consumer group permissions for ldms
      - resource:
          type: group
          name: ldms-consumer-group
          patternType: prefix
        operations:
          - Read
        host: "*"
{% endif %}
      # Producer permissions for ome topic (always created when Kafka is enabled)
      - resource:
          type: topic
          name: ome
          patternType: literal
        operations:
          - Write
          - Create
          - Describe
          - Read
        host: "*"
      # Consumer group permissions for ome
      - resource:
          type: group
          name: ome-consumer-group
          patternType: prefix
        operations:
          - Read
        host: "*"
      # Cluster-level permissions for idempotent producers
      - resource:
          type: cluster
        operations:
          - IdempotentWrite
        host: "*"
