---
# NetworkPolicy to restrict Kafka plaintext listener (port 9092) access
# Only allow LDMS store pods and Strimzi operators to access port 9092
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kafka-plaintext-access
  namespace: {{ telemetry_namespace }}
  labels:
    app: kafka
spec:
  # Apply to Kafka broker pods
  podSelector:
    matchLabels:
      strimzi.io/cluster: kafka
      strimzi.io/kind: Kafka
      strimzi.io/name: kafka-kafka
  
  policyTypes:
    - Ingress
  
  ingress:
    # Allow LDMS store pods to access port 9092 (plaintext listener)
    - from:
        - podSelector:
            matchLabels:
              app: nersc-ldms-store
      ports:
        - protocol: TCP
          port: 9092
    
    # Allow Strimzi operators to access for management
    - from:
        - namespaceSelector:
            matchLabels:
              name: {{ telemetry_namespace }}
          podSelector:
            matchLabels:
              strimzi.io/kind: cluster-operator
      ports:
        - protocol: TCP
          port: 9092
    
    # Allow access to TLS listeners (9093, 9094) from anywhere in namespace
    - from:
        - namespaceSelector:
            matchLabels:
              name: {{ telemetry_namespace }}
      ports:
        - protocol: TCP
          port: 9093
        - protocol: TCP
          port: 9094
    
    # Allow inter-broker communication (all ports)
    - from:
        - podSelector:
            matchLabels:
              strimzi.io/cluster: kafka
