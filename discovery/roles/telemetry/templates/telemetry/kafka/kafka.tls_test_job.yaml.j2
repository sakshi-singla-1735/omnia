#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-tls-test-script
  namespace: {{ telemetry_namespace }}
data:
  test-kafka-tls.sh: |
    #!/bin/bash
    set -e
    
    # Set Kafka bin path
    export PATH="/opt/kafka/bin:$PATH"
    
    echo "=========================================="
    echo "   Kafka TLS/mTLS Connection Test"
    echo "=========================================="
    echo "Bootstrap Server: kafka-kafka-bootstrap:9093"
    echo "Certificates: kafkapump (for all TLS topics)"
    echo "Testing topics based on enabled telemetry support:"
{% if hostvars['localhost']['idrac_telemetry_support'] and 'kafka' in hostvars['localhost']['idrac_telemetry_collection_type'].split(',') %}
    echo "  - iDRAC telemetry topic ({{ kafka.topics.idrac.name }})"
{% endif %}
{% if hostvars['localhost']['ldms_support'] %}
    echo "  - LDMS telemetry topic ({{ kafka.topics.ldms.name }})"
{% endif %}
    echo "Note: All topics use port 9093 with mTLS for testing"
    echo ""
    
    # Create truststore from cluster CA
    echo "Step 1: Creating Java truststore from cluster CA certificate..."
    keytool -import -trustcacerts -alias kafka-cluster-ca \
      -file /etc/kafka/cluster-ca/ca.crt \
      -keystore /tmp/truststore.jks \
      -storepass changeit -noprompt
    echo "✓ Truststore created successfully"
    echo ""
    
    # Create keystore from kafkapump client certificate (for all topics)
    echo "Step 2: Creating keystore with kafkapump client certificate..."
    openssl pkcs12 -export \
      -in /etc/kafka/kafkapump-certs/user.crt \
      -inkey /etc/kafka/kafkapump-certs/user.key \
      -out /tmp/kafkapump-keystore.p12 \
      -password pass:changeit \
      -name kafkapump
    echo "✓ kafkapump keystore created successfully"
    echo ""
    
    # Create kafka client properties file for kafkapump user
    echo "Step 3: Creating Kafka client properties..."
    echo "security.protocol=SSL" > /tmp/kafkapump-client.properties
    echo "ssl.truststore.location=/tmp/truststore.jks" >> /tmp/kafkapump-client.properties
    echo "ssl.truststore.password=changeit" >> /tmp/kafkapump-client.properties
    echo "ssl.keystore.location=/tmp/kafkapump-keystore.p12" >> /tmp/kafkapump-client.properties
    echo "ssl.keystore.password=changeit" >> /tmp/kafkapump-client.properties
    echo "ssl.keystore.type=PKCS12" >> /tmp/kafkapump-client.properties
    echo "✓ Client properties created"
    echo ""
    
    # List topics to verify TLS connection (using kafkapump user)
    echo "Step 4: Testing mTLS connection by listing topics..."
    /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka-kafka-bootstrap:9093 \
      --command-config /tmp/kafkapump-client.properties \
      --list
    echo "✓ mTLS connection successful"
    echo ""
    
{% if hostvars['localhost']['idrac_telemetry_support'] and 'kafka' in hostvars['localhost']['idrac_telemetry_collection_type'].split(',') %}
    # Test iDRAC telemetry topic consumer
    echo "Step 5: Testing consumer on {{ kafka.topics.idrac.name }} topic (kafkapump user)..."
    timeout 30 /opt/kafka/bin/kafka-console-consumer.sh \
      --bootstrap-server kafka-kafka-bootstrap:9093 \
      --topic {{ kafka.topics.idrac.name }} \
      --consumer.config /tmp/kafkapump-client.properties \
      --group {{ kafka.topics.idrac.consumer_group }} \
      --from-beginning \
      --max-messages 10 || echo "No messages or timeout (this is normal for {{ kafka.topics.idrac.name }})"
    echo ""
{% endif %}
    
{% if hostvars['localhost']['ldms_support'] %}
    # Test LDMS topic consumer
    echo "Step 6: Testing consumer on {{ kafka.topics.ldms.name }} topic (kafkapump user via TLS)..."
    timeout 30 /opt/kafka/bin/kafka-console-consumer.sh \
      --bootstrap-server kafka-kafka-bootstrap:9093 \
      --topic {{ kafka.topics.ldms.name }} \
      --consumer.config /tmp/kafkapump-client.properties \
      --group {{ kafka.topics.ldms.consumer_group }} \
      --from-beginning \
      --max-messages 10 || echo "No messages or timeout (this is normal for {{ kafka.topics.ldms.name }})"
    echo ""
{% endif %}
    
    echo ""
    echo "=== All tests completed ==="
    echo ""
    echo "Summary:"
    echo "  ✓ Truststore created (cluster CA)"
    echo "  ✓ kafkapump keystore created"
    echo "  ✓ mTLS connection established"
    echo "  ✓ Topics listed successfully"
{% if hostvars['localhost']['idrac_telemetry_support'] and 'kafka' in hostvars['localhost']['idrac_telemetry_collection_type'].split(',') %}
    echo "  ✓ {{ kafka.topics.idrac.name }} topic tested (kafkapump user)"
{% endif %}
{% if hostvars['localhost']['ldms_support'] %}
    echo "  ✓ {{ kafka.topics.ldms.name }} topic tested via TLS (kafkapump user)"
{% endif %}
    echo ""

---
apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-tls-test
  namespace: {{ telemetry_namespace }}
  labels:
    app: kafka-tls-test
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: kafka-tls-test
    spec:
      restartPolicy: Never
      volumes:
        - name: kafka-cluster-ca-cert
          secret:
            secretName: kafka-cluster-ca-cert
        - name: kafkapump-user-certs
          secret:
            secretName: kafkapump
        - name: test-script
          configMap:
            name: kafka-tls-test-script
            defaultMode: 0755
      containers:
        - name: kafka-tls-test
          image: {{ kafka.kafka_image }}
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - mountPath: /etc/kafka/cluster-ca
              name: kafka-cluster-ca-cert
              readOnly: true
            - mountPath: /etc/kafka/kafkapump-certs
              name: kafkapump-user-certs
              readOnly: true
            - mountPath: /opt/test
              name: test-script
          command: ["/bin/bash"]
          args: ["/opt/test/test-kafka-tls.sh"]
