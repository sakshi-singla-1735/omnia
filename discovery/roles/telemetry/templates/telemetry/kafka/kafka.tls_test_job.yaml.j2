#  Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-tls-test-script
  namespace: {{ telemetry_namespace }}
data:
  test-kafka-tls.sh: |
    #!/bin/bash
    set -e
    
    # Set Kafka bin path
    export PATH="/opt/kafka/bin:$PATH"
    
    echo "=========================================="
    echo "   Kafka TLS/mTLS Connection Test"
    echo "=========================================="
    echo "Bootstrap Server: kafka-kafka-bootstrap:9093"
    echo "Certificates: kafkapump (idrac_telemetry), ldms-producer (ldms)"
    echo ""
    
    # Create truststore from cluster CA
    echo "Step 1: Creating Java truststore from cluster CA certificate..."
    keytool -import -trustcacerts -alias kafka-cluster-ca \
      -file /etc/kafka/cluster-ca/ca.crt \
      -keystore /tmp/truststore.jks \
      -storepass changeit -noprompt
    echo "✓ Truststore created successfully"
    echo ""
    
    # Create keystore from kafkapump client certificate (for idrac_telemetry)
    echo "Step 2: Creating keystore with kafkapump client certificate..."
    openssl pkcs12 -export \
      -in /etc/kafka/kafkapump-certs/user.crt \
      -inkey /etc/kafka/kafkapump-certs/user.key \
      -out /tmp/kafkapump-keystore.p12 \
      -password pass:changeit \
      -name kafkapump
    echo "✓ kafkapump keystore created successfully"
    echo ""
    
    # Create keystore from ldms-producer client certificate (for ldms topic)
    echo "Step 3: Creating keystore with ldms-producer client certificate..."
    openssl pkcs12 -export \
      -in /etc/kafka/ldms-certs/user.crt \
      -inkey /etc/kafka/ldms-certs/user.key \
      -out /tmp/ldms-keystore.p12 \
      -password pass:changeit \
      -name ldms-producer
    echo "✓ ldms-producer keystore created successfully"
    echo ""
    
    # Create kafka client properties file for kafkapump user
    echo "security.protocol=SSL" > /tmp/kafkapump-client.properties
    echo "ssl.truststore.location=/tmp/truststore.jks" >> /tmp/kafkapump-client.properties
    echo "ssl.truststore.password=changeit" >> /tmp/kafkapump-client.properties
    echo "ssl.keystore.location=/tmp/kafkapump-keystore.p12" >> /tmp/kafkapump-client.properties
    echo "ssl.keystore.password=changeit" >> /tmp/kafkapump-client.properties
    echo "ssl.keystore.type=PKCS12" >> /tmp/kafkapump-client.properties
    
    # Create kafka client properties file for ldms-producer user
    echo "security.protocol=SSL" > /tmp/ldms-client.properties
    echo "ssl.truststore.location=/tmp/truststore.jks" >> /tmp/ldms-client.properties
    echo "ssl.truststore.password=changeit" >> /tmp/ldms-client.properties
    echo "ssl.keystore.location=/tmp/ldms-keystore.p12" >> /tmp/ldms-client.properties
    echo "ssl.keystore.password=changeit" >> /tmp/ldms-client.properties
    echo "ssl.keystore.type=PKCS12" >> /tmp/ldms-client.properties
    
    # List topics to verify TLS connection (using kafkapump user)
    echo "Step 4: Testing mTLS connection by listing topics..."
    /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka-kafka-bootstrap:9093 \
      --command-config /tmp/kafkapump-client.properties \
      --list
    echo "✓ mTLS connection successful"
    echo ""
    
    # Test iDRAC telemetry topic consumer
    echo "Step 5: Testing consumer on idrac_telemetry topic (kafkapump user)..."
    timeout 10 /opt/kafka/bin/kafka-console-consumer.sh \
      --bootstrap-server kafka-kafka-bootstrap:9093 \
      --topic idrac_telemetry \
      --consumer.config /tmp/kafkapump-client.properties \
      --group idrac-consumer-group \
      --from-beginning \
      --max-messages 10 || echo "No messages or timeout (this is normal for idrac_telemetry)"
    echo ""
    
    # Test LDMS topic consumer with ldms-producer user
    echo "Step 6: Testing consumer on ldms topic (ldms-producer user)..."
    timeout 10 /opt/kafka/bin/kafka-console-consumer.sh \
      --bootstrap-server kafka-kafka-bootstrap:9093 \
      --topic ldms \
      --consumer.config /tmp/ldms-client.properties \
      --group ldms-consumer-group \
      --from-beginning \
      --max-messages 10 || echo "No messages or timeout (this is normal for ldms)"
    
    echo ""
    echo "=== All tests completed ==="
    echo ""
    echo "Summary:"
    echo "  ✓ Truststore created (cluster CA)"
    echo "  ✓ kafkapump keystore created"
    echo "  ✓ ldms-producer keystore created"
    echo "  ✓ mTLS connection established"
    echo "  ✓ Topics listed successfully"
    echo "  ✓ idrac_telemetry topic tested (kafkapump user)"
    echo "  ✓ ldms topic tested (ldms-producer user)"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-tls-test
  namespace: {{ telemetry_namespace }}
  labels:
    app: kafka-tls-test
spec:
  ttlSecondsAfterFinished: 3600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: kafka-tls-test
    spec:
      restartPolicy: Never
      volumes:
        - name: kafka-cluster-ca-cert
          secret:
            secretName: kafka-cluster-ca-cert
        - name: kafkapump-user-certs
          secret:
            secretName: kafkapump
        - name: ldms-producer-user-certs
          secret:
            secretName: ldms-producer
        - name: test-script
          configMap:
            name: kafka-tls-test-script
            defaultMode: 0755
      containers:
        - name: kafka-tls-test
          image: quay.io/strimzi/kafka:0.48.0-kafka-4.1.0
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - mountPath: /etc/kafka/cluster-ca
              name: kafka-cluster-ca-cert
              readOnly: true
            - mountPath: /etc/kafka/kafkapump-certs
              name: kafkapump-user-certs
              readOnly: true
            - mountPath: /etc/kafka/ldms-certs
              name: ldms-producer-user-certs
              readOnly: true
            - mountPath: /opt/test
              name: test-script
          command: ["/bin/bash"]
          args: ["/opt/test/test-kafka-tls.sh"]
