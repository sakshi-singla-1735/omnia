#!/bin/bash
#
# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
#
# Telemetry Stack Cleanup Script
# Removes Kafka, LDMS, iDRAC telemetry, and monitoring resources from the {{ telemetry_namespace }} namespace
#
# Usage: ./cleanup_telemetry.sh [kafka] [ldms] [idrac] [victoria] [all]
#   kafka    - Delete Kafka cluster, users, and bridge
#   ldms     - Delete LDMS aggregator and store
#   idrac    - Delete iDRAC telemetry
#   victoria - Delete VictoriaMetrics monitoring
#   all      - Delete everything (default if no arguments)
#

set -e

NAMESPACE="{{ telemetry_namespace }}"

# Parse arguments
CLEAN_KAFKA=false
CLEAN_LDMS=false
CLEAN_IDRAC=false
CLEAN_VICTORIA=false
CLEAN_ALL=false

if [ $# -eq 0 ]; then
    CLEAN_ALL=true
else
    for arg in "$@"; do
        case $arg in
            kafka)
                CLEAN_KAFKA=true
                ;;
            ldms)
                CLEAN_LDMS=true
                ;;
            idrac)
                CLEAN_IDRAC=true
                ;;
            victoria)
                CLEAN_VICTORIA=true
                ;;
            all)
                CLEAN_ALL=true
                ;;
            -h|--help)
                echo "Usage: $0 [kafka] [ldms] [idrac] [victoria] [all]"
                echo ""
                echo "Options:"
                echo "  kafka    - Delete Kafka cluster, users, and bridge"
                echo "  ldms     - Delete LDMS aggregator and store"
                echo "  idrac    - Delete iDRAC telemetry"
                echo "  victoria - Delete VictoriaMetrics monitoring"
                echo "  all      - Delete everything (default if no arguments)"
                echo ""
                echo "Examples:"
                echo "  $0                    # Delete everything"
                echo "  $0 all                # Delete everything"
                echo "  $0 kafka ldms         # Delete only Kafka and LDMS"
                echo "  $0 idrac victoria     # Delete only iDRAC and Victoria"
                exit 0
                ;;
            *)
                echo "Unknown option: $arg"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done
fi

# If CLEAN_ALL is true, enable all cleanup flags
if [ "$CLEAN_ALL" = true ]; then
    CLEAN_KAFKA=true
    CLEAN_LDMS=true
    CLEAN_IDRAC=true
    CLEAN_VICTORIA=true
fi

echo "=========================================="
echo "  Telemetry Stack Cleanup"
echo "=========================================="
echo ""
echo "Components to clean:"
echo "  Kafka Bridge:    $([ "$CLEAN_KAFKA" = true ] && echo "YES" || echo "NO")"
echo "  Kafka Cluster:   $([ "$CLEAN_KAFKA" = true ] && echo "YES" || echo "NO")"
echo "  LDMS:            $([ "$CLEAN_LDMS" = true ] && echo "YES" || echo "NO")"
echo "  iDRAC Telemetry: $([ "$CLEAN_IDRAC" = true ] && echo "YES" || echo "NO")"
echo "  Victoria Metrics:$([ "$CLEAN_VICTORIA" = true ] && echo "YES" || echo "NO")"
echo ""
read -p "Continue? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Cleanup cancelled."
    exit 0
fi
echo ""

# Function to delete resource with retry
delete_resource() {
    local resource=$1
    local name=$2
    echo "Deleting $resource: $name"
    kubectl -n $NAMESPACE delete $resource $name --ignore-not-found=true --wait=false 2>/dev/null || true
}

# Function to delete all resources of a type with label selector
delete_all() {
    local resource=$1
    local label=$2
    if [ -z "$label" ]; then
        echo "Deleting all $resource resources..."
        kubectl -n $NAMESPACE delete $resource --all --ignore-not-found=true --wait=false 2>/dev/null || true
    else
        echo "Deleting $resource resources with label $label..."
        kubectl -n $NAMESPACE delete $resource -l $label --ignore-not-found=true --wait=false 2>/dev/null || true
    fi
}

if [ "$CLEAN_KAFKA" = true ]; then
    echo "Step 1: Delete Kafka Bridge"
    echo "----------------------------"
    delete_resource kafkabridge bridge
    delete_resource service bridge-bridge-service
    delete_resource service bridge-bridge-lb
    delete_resource deployment bridge-bridge
    sleep 2
    echo ""
fi

if [ "$CLEAN_IDRAC" = true ]; then
    echo "Step 2: Delete iDRAC Telemetry"
    echo "-------------------------------"
    delete_resource statefulset idrac-telemetry
    delete_resource service idrac-telemetry-headless
    delete_resource service idrac-telemetry-service
    delete_resource configmap idrac-telemetry-config
    delete_all pod "app=idrac-telemetry"
    sleep 2
    echo ""
fi

if [ "$CLEAN_LDMS" = true ]; then
    echo "Step 3: Delete LDMS Helm Releases"
    echo "----------------------------------"
    # Check if Helm releases exist and delete them
    if helm list -n $NAMESPACE 2>/dev/null | grep -q "nersc-ldms-aggr"; then
        echo "Deleting Helm release: nersc-ldms-aggr"
        helm delete nersc-ldms-aggr -n $NAMESPACE 2>/dev/null || true
    fi

    if helm list -n $NAMESPACE 2>/dev/null | grep -q "nersc-ldms-store"; then
        echo "Deleting Helm release: nersc-ldms-store"
        helm delete nersc-ldms-store -n $NAMESPACE 2>/dev/null || true
    fi

    # Wait for Helm resources to be deleted
    sleep 5

    # Clean up any remaining LDMS resources
    echo "Cleaning up remaining LDMS resources..."
    # LDMS StatefulSets
    delete_resource statefulset nersc-ldms-aggr
    delete_resource statefulset nersc-ldms-store-slurm-cluster
    delete_resource statefulset nersc-ldms-store-slurm-cluster-0
    delete_resource statefulset nersc-ldms-aggr-0

    # LDMS Services
    delete_resource service nersc-ldms-aggr
    delete_resource service nersc-ldms-store
    delete_resource service nersc-ldms-store-slurm-cluster-0
    delete_resource service nersc-ldms-aggr-0

    # LDMS ConfigMaps
    delete_resource configmap nersc-ldms-store-slurm-cluster-0-config
    delete_resource configmap nersc-ldms-aggr-0-config

    # Delete any LDMS pods
    delete_all pod "app=nersc-ldms"
    

    sleep 2
    echo ""
fi

if [ "$CLEAN_KAFKA" = true ]; then
    echo "Step 4: Delete Kafka Users"
    echo "--------------------------"
    delete_resource kafkauser kafkapump
    sleep 2

    echo ""
    echo "Step 5: Delete Kafka Cluster"
    echo "-----------------------------"
    delete_resource kafka kafka
    echo "Waiting for Kafka cluster to terminate (this may take 2-3 minutes)..."
    kubectl -n $NAMESPACE wait --for=delete kafka/kafka --timeout=300s 2>/dev/null || true
    sleep 5

    echo ""
    echo "Step 6: Delete Kafka Node Pools"
    echo "--------------------------------"
    delete_resource kafkanodepool broker
    delete_resource kafkanodepool controller
    sleep 2
    echo ""
fi

if [ "$CLEAN_KAFKA" = true ] || [ "$CLEAN_LDMS" = true ] || [ "$CLEAN_IDRAC" = true ] || [ "$CLEAN_VICTORIA" = true ]; then
    echo "Step 7: Delete Persistent Volume Claims"
    echo "----------------------------------------"
    if [ "$CLEAN_KAFKA" = true ]; then
        delete_all pvc "strimzi.io/cluster=kafka"
    fi
    if [ "$CLEAN_LDMS" = true ]; then
        delete_all pvc "app=nersc-ldms"
    fi
    if [ "$CLEAN_IDRAC" = true ]; then
        delete_all pvc "app=idrac-telemetry"
    fi
    if [ "$CLEAN_VICTORIA" = true ]; then
        # Delete single-node PVCs
        delete_all pvc "app=victoria-metric"
        delete_resource pvc victoria-metrics-pvc-victoria-metric-0
        # Delete cluster mode PVCs (vmstorage StatefulSet PVCs)
        delete_all pvc "app=vmstorage"
        for i in {0..9}; do
            delete_resource pvc vmstorage-data-vmstorage-$i
        done
    fi
    sleep 2
    echo ""
fi

if [ "$CLEAN_KAFKA" = true ]; then
    echo "Step 8: Delete Kafka Secrets"
    echo "-----------------------------"
    delete_all secret "strimzi.io/cluster=kafka"
    delete_resource secret kafka-cluster-ca-cert
    delete_resource secret kafka-cluster-ca
    delete_resource secret kafka-clients-ca
    delete_resource secret kafkapump
    delete_resource secret kafka-secrets
    delete_resource secret kafka-cluster-id
    sleep 2
    echo ""
fi

if [ "$CLEAN_LDMS" = true ]; then
    echo "Step 8a: Delete LDMS Secrets"
    echo "-----------------------------"
    delete_resource secret nersc-ldms-ovis-auth
    delete_resource secret nersc-munge-key
    sleep 2
    echo ""
fi

if [ "$CLEAN_IDRAC" = true ]; then
    echo "Step 8b: Delete MySQL Secrets"
    echo "------------------------------"
    delete_resource secret mysqldb-credentials
    sleep 2
    echo ""
fi

if [ "$CLEAN_KAFKA" = true ] || [ "$CLEAN_LDMS" = true ] || [ "$CLEAN_IDRAC" = true ] || [ "$CLEAN_VICTORIA" = true ]; then
    echo "Step 9: Delete ConfigMaps"
    echo "-------------------------"
    if [ "$CLEAN_KAFKA" = true ]; then
        delete_all configmap "app=kafka"
        delete_resource configmap kafka-tls-test-script
    fi
    if [ "$CLEAN_LDMS" = true ]; then
        delete_all configmap "app=nersc-ldms"
    fi
    if [ "$CLEAN_IDRAC" = true ]; then
        delete_all configmap "app=idrac-telemetry"
    fi
    if [ "$CLEAN_VICTORIA" = true ]; then
        delete_resource configmap victoria-tls-test-script
    fi
    sleep 2
    echo ""
fi

if [ "$CLEAN_KAFKA" = true ] || [ "$CLEAN_VICTORIA" = true ]; then
    echo "Step 10: Delete TLS Test Jobs"
    echo "------------------------------"
    if [ "$CLEAN_KAFKA" = true ]; then
        delete_resource job kafka-tls-test
    fi
    if [ "$CLEAN_VICTORIA" = true ]; then
        delete_resource job victoria-tls-test
    fi
    sleep 2
    echo ""
fi

if [ "$CLEAN_KAFKA" = true ] || [ "$CLEAN_VICTORIA" = true ]; then
    echo "Step 11: Delete Services"
    echo "------------------------"
    if [ "$CLEAN_KAFKA" = true ]; then
        delete_resource service kafka-kafka-bootstrap
        delete_resource service kafka-kafka-brokers
        delete_resource service kafka-kafka-controllers
    fi
    if [ "$CLEAN_VICTORIA" = true ]; then
        delete_resource service victoria-metric
        delete_resource service vmselect
        delete_resource service vminsert
        delete_resource service vmstorage
        delete_resource service vmagent
    fi
    sleep 2
    echo ""
fi

if [ "$CLEAN_VICTORIA" = true ]; then
    echo "Step 12: Delete Monitoring Resources"
    echo "-------------------------------------"
    
    # Delete VictoriaMetrics cluster components (if cluster mode is deployed)
    echo "Deleting VictoriaMetrics cluster components..."
    delete_resource deployment vmselect
    delete_resource deployment vminsert
    delete_resource statefulset vmstorage
    delete_resource service vmselect
    delete_resource service vminsert
    delete_resource service vmstorage
    delete_all pod "app=vmselect"
    delete_all pod "app=vminsert"
    delete_all pod "app=vmstorage"
    
    # Delete VictoriaMetrics single-node components (if single-node mode is deployed)
    echo "Deleting VictoriaMetrics single-node components..."
    delete_resource statefulset victoria-metric
    delete_resource service victoria-loadbalancer
    delete_resource service victoria-metric
    delete_all pod "app=victoria-metric"
    
    # Delete vmagent (common to both modes)
    echo "Deleting vmagent..."
    delete_resource deployment vmagent
    delete_resource service vmagent
    delete_all pod "app=vmagent"
    
    # Delete shared resources
    echo "Deleting VictoriaMetrics shared resources..."
    delete_resource configmap vmagent-config
    delete_resource configmap vmagent-scrape-config
    delete_resource configmap victoria-metric-config
    delete_resource secret victoria-tls-certs
    delete_resource serviceaccount vmagent
    delete_resource role vmagent-sd
    delete_resource rolebinding vmagent-sd-binding
    
    sleep 2
    echo ""
fi

echo ""
echo "Step 13: Force Delete Any Remaining Component Pods"
echo "---------------------------------------------------"
# Only force delete pods from components being cleaned
if [ "$CLEAN_KAFKA" = true ]; then
    kubectl -n $NAMESPACE delete pod -l strimzi.io/cluster=kafka --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
    kubectl -n $NAMESPACE delete pod -l app.kubernetes.io/name=kafka-bridge --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
    kubectl -n $NAMESPACE delete pod -l app=kafka-tls-test --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
fi
if [ "$CLEAN_LDMS" = true ]; then
    kubectl -n $NAMESPACE delete pod -l app=nersc-ldms --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
fi
if [ "$CLEAN_IDRAC" = true ]; then
    kubectl -n $NAMESPACE delete pod -l app=idrac-telemetry --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
fi
if [ "$CLEAN_VICTORIA" = true ]; then
    kubectl -n $NAMESPACE delete pod -l app=victoria-metric --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
    kubectl -n $NAMESPACE delete pod -l app=vmselect --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
    kubectl -n $NAMESPACE delete pod -l app=vminsert --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
    kubectl -n $NAMESPACE delete pod -l app=vmstorage --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
    kubectl -n $NAMESPACE delete pod -l app=vmagent --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
    kubectl -n $NAMESPACE delete pod -l app=victoria-tls-test --grace-period=0 --force --ignore-not-found=true 2>/dev/null || true
fi
sleep 5

echo ""
echo "Step 14: Check for Remaining Resources"
echo "---------------------------------------"
if [ "$CLEAN_KAFKA" = true ]; then
    echo "Remaining Kafka resources:"
    kubectl -n $NAMESPACE get kafka,kafkauser,kafkabridge,kafkanodepool 2>/dev/null || echo "  None"
    echo ""
fi
if [ "$CLEAN_LDMS" = true ]; then
    echo "Remaining LDMS resources:"
    kubectl -n $NAMESPACE get statefulset,pod,configmap -l app=nersc-ldms 2>/dev/null || echo "  None"
    echo ""
fi
if [ "$CLEAN_IDRAC" = true ]; then
    echo "Remaining iDRAC resources:"
    kubectl -n $NAMESPACE get statefulset,pod,configmap -l app=idrac-telemetry 2>/dev/null || echo "  None"
    echo ""
fi
if [ "$CLEAN_VICTORIA" = true ]; then
    echo "Remaining Victoria Metrics resources:"
    echo "  Single-node:"
    kubectl -n $NAMESPACE get statefulset,deployment,pod,configmap -l app=victoria-metric 2>/dev/null || echo "    None"
    echo "  Cluster (vmselect):"
    kubectl -n $NAMESPACE get deployment,pod -l app=vmselect 2>/dev/null || echo "    None"
    echo "  Cluster (vminsert):"
    kubectl -n $NAMESPACE get deployment,pod -l app=vminsert 2>/dev/null || echo "    None"
    echo "  Cluster (vmstorage):"
    kubectl -n $NAMESPACE get statefulset,pod -l app=vmstorage 2>/dev/null || echo "    None"
    echo "  vmagent:"
    kubectl -n $NAMESPACE get deployment,pod -l app=vmagent 2>/dev/null || echo "    None"
    echo ""
fi
echo "Remaining PVCs:"
kubectl -n $NAMESPACE get pvc 2>/dev/null || echo "  None"
echo ""
echo "Remaining Network Policies:"
kubectl -n $NAMESPACE get networkpolicy 2>/dev/null || echo "  None"
echo ""
echo "All pods:"
kubectl -n $NAMESPACE get pods 2>/dev/null || echo "  None"

echo ""
echo "=========================================="
echo "  Cleanup Complete!"
echo "=========================================="
echo ""

# Only show operator prompt if Kafka was cleaned
if [ "$CLEAN_KAFKA" = true ]; then
    echo ""
    echo "=========================================="
    echo "  Strimzi Cluster Operator Cleanup"
    echo "=========================================="
    echo ""
    echo "The Strimzi Cluster Operator is still running."
    echo "Do you want to delete it as well?"
    echo ""
    read -p "Delete Strimzi Cluster Operator? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo "Deleting Strimzi Cluster Operator..."
        kubectl -n $NAMESPACE delete deployment strimzi-cluster-operator --ignore-not-found=true --wait=false 2>/dev/null || true
        kubectl -n $NAMESPACE delete secret sh.helm.release.v1.strimzi-cluster-operator.v1 --ignore-not-found=true 2>/dev/null || true
        echo "Strimzi Cluster Operator deleted."
    else
        echo "Strimzi Cluster Operator was NOT deleted."
    fi
    echo ""
fi

echo "To delete the entire namespace:"
echo "  kubectl delete namespace $NAMESPACE"
echo ""
