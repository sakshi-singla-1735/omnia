---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pod-cleanup
  namespace: telemetry
spec:
  schedule: "*/5 * * * *" # Every 5 minutes
  successfulJobsHistoryLimit: 1   # Keep only 1 successful job
  failedJobsHistoryLimit: 1       # Keep only 1 failed job
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 60 # Auto-delete job and pod after 60s
      template:
        spec:
          containers:
          - name: kubectl-cleanup
            image: docker.io/alpine/kubectl:1.34.1
            command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache coreutils
              set -e
              pods=$(kubectl get pods -n telemetry \
                -o jsonpath='{range .items[*]}{.metadata.name}{"|"}{.metadata.deletionTimestamp}{"\n"}{end}')

              if [ -z "$pods" ]; then
                echo "No terminating pods found"
                exit 0
              fi

              now=$(date +%s)
              echo "$pods" | while IFS="|" read -r pod deletion_ts; do
                if [ -n "$deletion_ts" ]; then
                  # Skip Kafka pods - let Strimzi operator handle them
                  if echo "$pod" | grep -q "kafka"; then
                    echo "Skipping Kafka pod $pod - managed by Strimzi operator"
                    continue
                  fi
                  
                  deletion_time=$(date -d "$deletion_ts" +%s || echo 0)
                  age=$((now - deletion_time))
                  if [ $age -gt 60 ]; then
                    echo "Pod $pod has been terminating for $age seconds. Cleaning up..."
                    kubectl patch pod "$pod" -n telemetry -p '{"metadata":{"finalizers":[]}}' --type=merge || true
                    kubectl delete pod "$pod" -n telemetry --grace-period=0 --force || true
                  else
                    echo "Pod $pod is terminating but only for $age seconds. Skipping."
                  fi
                fi
              done
              echo "Cleanup complete"
              
              # Additional cleanup: Remove lock files from orphaned PVCs (atomic approach)
              echo "Checking for orphaned PVCs..."
              
              # Get all PVCs in telemetry namespace
              all_pvcs=$(kubectl get pvc -n telemetry -o jsonpath='{.items[*].metadata.name}')
              
              # Collect orphaned PVCs
              orphaned_pvcs=""
              for pvc in $all_pvcs; do
                pod_using_pvc=$(kubectl get pods -n telemetry -o jsonpath="{.items[?(@.spec.volumes[*].persistentVolumeClaim.claimName=='$pvc')].metadata.name}" 2>/dev/null)
                if [ -z "$pod_using_pvc" ]; then
                  orphaned_pvcs="$orphaned_pvcs $pvc"
                  echo "  → $pvc (orphaned)"
                else
                  echo "  → $pvc (in use by $pod_using_pvc)"
                fi
              done
              
              # Clean all orphaned PVCs at once if any found
              if [ -n "$orphaned_pvcs" ]; then
                echo "Creating atomic cleanup job for orphaned PVCs..."
                
                # Build volumeMounts and volumes JSON arrays
                volume_mounts=""
                volumes=""
                idx=0
                for pvc in $orphaned_pvcs; do
                  volume_mounts="$volume_mounts{\\\"name\\\":\\\"vol$idx\\\",\\\"mountPath\\\":\\\"/mnt/vol$idx\\\"},"
                  volumes="$volumes{\\\"name\\\":\\\"vol$idx\\\",\\\"persistentVolumeClaim\\\":{\\\"claimName\\\":\\\"$pvc\\\"}},"
                  idx=$((idx + 1))
                done
                # Remove trailing commas
                volume_mounts="${volume_mounts%,}"
                volumes="${volumes%,}"
                
                # Create single cleanup job that mounts all orphaned PVCs
                cleanup_job="pvc-cleanup-$(date +%s)"
                kubectl run $cleanup_job --image=busybox:1.36 -n telemetry --rm --restart=Never \
                  --overrides="{\\\"spec\\\":{\\\"containers\\\":[{\\\"name\\\":\\\"cleanup\\\",\\\"image\\\":\\\"busybox:1.36\\\",\\\"command\\\":[\\\"/bin/sh\\\",\\\"-c\\\",\\\"echo Cleaning all orphaned PVCs...; for dir in /mnt/*; do find \$dir \\\\\\\\( -name .lock -o -name '*.sock' -o -name '*.pid' \\\\\\\\) -type f -exec rm -f {} \\\\\\\\; 2>/dev/null || true; done; echo Done\\\"],\\\"volumeMounts\\\":[$volume_mounts]}],\\\"volumes\\\":[$volumes]}}" \
                  --timeout=120s 2>/dev/null && echo "✓ Cleaned all orphaned PVCs atomically" || echo "✗ Cleanup failed (PVCs might have been claimed)"
              else
                echo "No orphaned PVCs found. Skipping cleanup."
              fi
              
              echo "PVC lock file cleanup complete"
              
              exit 0
          restartPolicy: Never
          serviceAccountName: telemetry-cleaner
