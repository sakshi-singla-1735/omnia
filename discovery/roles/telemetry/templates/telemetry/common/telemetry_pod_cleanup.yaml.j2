---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pod-cleanup
  namespace: telemetry
spec:
  schedule: "*/5 * * * *" # Every 5 minutes
  successfulJobsHistoryLimit: 1   # Keep only 1 successful job
  failedJobsHistoryLimit: 1       # Keep only 1 failed job
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 60 # Delete job and pod after 60s
      template:
        spec:
          containers:
          - name: kubectl-cleanup
            image: docker.io/alpine/kubectl:v1.34.1
            command:
            - /bin/sh
            - -c
            - |
              set -e
              pods=$(kubectl get pods -n telemetry --field-selector=status.phase=Running \
                -o jsonpath='{range .items[*]}{.metadata.name}{"|"}{.metadata.deletionTimestamp}{"\n"}{end}')

              if [ -z "$pods" ]; then
                echo "No terminating pods found"
                exit 0
              fi

              now=$(date +%s)
              echo "$pods" | while IFS="|" read -r pod deletion_ts; do
                if [ -n "$deletion_ts" ]; then
                  deletion_time=$(date -d "$deletion_ts" +%s || echo 0)
                  if [ $((now - deletion_time)) -gt 60 ]; then
                    echo "Removing finalizers from pod: $pod"
                    kubectl patch pod "$pod" -n telemetry -p '{"metadata":{"finalizers":[]}}' --type=merge || true
                    echo "Force deleting pod: $pod"
                    kubectl delete pod "$pod" -n telemetry --grace-period=0 --force || true
                  fi
                fi
              done
              echo "Cleanup complete"
              exit 0
          restartPolicy: Never
          serviceAccountName: telemetry-cleaner
