{
  "title": "omnia_config.yaml",
  "description": "Omnia slurm and k8s config related parameters",
  "type": "object",
  "properties": {
    "slurm_cluster": {
      "type": "array",
      "description": "List of slurm cluster configurations.",
      "items": {
        "type": "object",
        "properties": {
          "cluster_name": { 
            "type": "string", 
            "minLength": 1,
            "description": "Unique name for the slurm cluster." 
          },
          "nfs_storage_name": { 
            "type": "string", 
            "minLength": 1,
            "description": "Name of the nfs storage in storage_config.yml" 
          },
          "config_sources": {
            "type": "object",
            "description": "Config can be a file path or inline mapping",
            "additionalProperties": {
              "oneOf": [
                {
                  "type": "object",
                  "description": "Inline configuration mapping",
                  "additionalProperties": true
                }
              ]
            }
          }
        },
        "required": [
          "cluster_name",
          "nfs_storage_name"
        ]
      }
    },
    "service_k8s_cluster": {
      "type": "array",
      "description": "List of service Kubernetes cluster configurations.",
      "items": {
        "type": "object",
        "properties": {
          "cluster_name": { 
            "type": "string",
            "minLength": 1,
            "description": "Unique name for the service Kubernetes cluster." 
          },
          "deployment": {
            "type": "boolean"
          },
          "k8s_cni": {
            "enum": ["calico"],
            "description": "K8s CNI plugin to use for this cluster."
          },
          "pod_external_ip_range": { 
            "description": "Kubernetes pod network CIDR for internal network",
            "type":"string",
            "pattern":"^(?:(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)-(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))|(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/[0-9]{1,2}$|^$"
          },
          "k8s_service_addresses": {
            "type": "string",
            "pattern": "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/[0-9]{1,2}$",
            "description": "CIDR for K8s service IPs."
          },
          "k8s_pod_network_cidr": {
            "type": "string",
            "pattern": "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)/[0-9]{1,2}$",
            "description": "CIDR for K8s pod network."
          },
          "nfs_storage_name": {
            "type": "string",
            "description": "The NFS client server name mentioned in storage_config.yml"
          },
          "csi_powerscale_driver_secret_file_path": {
            "description": "Absolute file path for the secret.yaml file.",
            "type": "string",
            "pattern": "^(|/?([a-zA-Z0-9._-]+/)*[a-zA-Z0-9._-]+\\.yaml)$"
          },
          "csi_powerscale_driver_values_file_path": {
            "description": "File path for the values.yaml file.",
            "type": "string",
            "pattern": "^(|/?([a-zA-Z0-9._-]+/)*[a-zA-Z0-9._-]+\\.yaml)$"

          },
          "k8s_crio_storage_size": {
            "description": "Storage size for CRI-O in Gigabytes only (example: 10G, 15G, 100G)",
            "type": "string",
            "pattern": "^[1-9][0-9]*G$"
          }
        },
        "required": [
          "cluster_name",
          "k8s_cni",
          "k8s_service_addresses",
          "k8s_crio_storage_size"
        ],
        "allOf": [
        {
          "if": {
            "properties": {
              "csi_powerscale_driver_secret_file_path": {
                "type": "string",
                "minLength": 1
              }
            },
            "required": ["csi_powerscale_driver_secret_file_path"]
          },
          "then": {
            "required": ["csi_powerscale_driver_values_file_path"]
          }
        }
      ]
      }
    }
},
  "required": [
     "slurm_cluster",
     "service_k8s_cluster"
    ]
}
