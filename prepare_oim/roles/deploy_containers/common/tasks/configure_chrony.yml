# Copyright 2025 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Install chrony
  ansible.builtin.package:
    name: chrony
    state: present

- name: Update chrony.conf
  ansible.builtin.lineinfile:
    path: "{{ chrony_conf_path }}"
    regexp: ^#allow
    line: "allow {{ hostvars['localhost']['admin_net_addr'] }}/{{ hostvars['localhost']['admin_netmask_bits'] }}"
    state: present

- name: Enable and start chronyd service
  ansible.builtin.service:
    name: chronyd
    enabled: true
    state: restarted

- name: Chronyc sources
  ansible.builtin.command: chronyc sources
  changed_when: false
  register: chronyc_sources
  until: chronyc_sources is not failed
  retries: "{{ hostvars['localhost']['fail_retry'] }}"
  delay: "{{ hostvars['localhost']['fail_delay'] }}"

- name: Retrieve NTP servers
  ansible.builtin.set_fact:
    ntp_servers: "{{ hostvars['localhost']['ntp_servers'] | default([]) }}"

- name: Configure NTP servers in chrony when ntp_servers are provided
  when:
    - ntp_servers is defined
    - ntp_servers | length > 0
  block:
    - name: Check reachability of configured NTP servers
      ansible.builtin.command: "ping -c 1 {{ item.address }}"
      register: ntp_ping_results
      changed_when: false
      failed_when: false
      loop: "{{ ntp_servers | default([]) }}"

    - name: Build list of reachable NTP servers
      ansible.builtin.set_fact:
        reachable_ntp_servers: "{{ ntp_ping_results.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list }}"

    - name: Remove existing NTP server and pool entries from chrony.conf
      ansible.builtin.lineinfile:
        path: "{{ chrony_conf_path }}"
        regexp: '^(server|pool)\s+'
        state: absent
      when:
        - reachable_ntp_servers is defined
        - reachable_ntp_servers | length > 0

    - name: Manage NTP server entries in chrony.conf
      ansible.builtin.blockinfile:
        path: "{{ chrony_conf_path }}"
        marker: "# {mark} ANSIBLE MANAGED NTP SERVERS"
        block: |
          {% for srv in reachable_ntp_servers %}
          {{ srv.type }} {{ srv.address }} iburst
          {% endfor %}
      when:
        - reachable_ntp_servers is defined
        - reachable_ntp_servers | length > 0

    - name: Enable and start chronyd service
      ansible.builtin.service:
        name: chronyd
        enabled: true
        state: restarted

    - name: Chronyc sources
      ansible.builtin.command: chronyc sources
      changed_when: false
      register: chronyc_sources
      until: chronyc_sources is not failed
      retries: "{{ hostvars['localhost']['fail_retry'] }}"
      delay: "{{ hostvars['localhost']['fail_delay'] }}"

    - name: Check reachable chrony sources
      ansible.builtin.shell: |
        set -o pipefail
        chronyc sources -n | awk 'NR>2 { if ($5+0 > 0) print $2 " " $5 }' | uniq
      args:
        executable: /bin/bash
      register: chrony_reachable_sources
      changed_when: false
      failed_when: false

    - name: Fail if no chrony sources are reachable
      ansible.builtin.fail:
        msg: "{{ chrony_no_sources_msg }}"
      when:
        - reachable_ntp_servers is defined
        - reachable_ntp_servers | length > 0
        - chrony_reachable_sources.stdout_lines | length == 0
